/**
 * ç´«å¾®æ–—æ•°è®¡ç®—å·¥å…·å‡½æ•°
 * Calculation utility functions for ZiWei DouShu
 * 
 * æœ¬æ–‡ä»¶åŒ…å«ç´«å¾®æ–—æ•°æ‰€æœ‰æ ¸å¿ƒè®¡ç®—ç®—æ³•çš„å®ç°ï¼ŒåŸºäºä¼ ç»Ÿå‘½ç†å­¦ç†è®ºå’Œ tyme4ts å†œå†åº“ã€‚
 * 
 * ## ğŸ“ åŒé‡/ä¸‰é‡æ•°å€¼ä½“ç³»è®¾è®¡æ ‡å‡†
 * 
 * ### åŸºç¡€åŒé‡æ•°å€¼ (Dual-Value)
 * - `value`: è®¡ç®—æ„ä¹‰æ•°å€¼ (ç”¨äºæ˜¾ç¤ºï¼Œå¦‚"å‘½å®«"ã€"ç´«å¾®"ã€"åº™")
 * - `index`: æ¸²æŸ“æ„ä¹‰æ•°å€¼ (ç”¨äºå¤„ç†ï¼Œå¦‚0-11å®«ä½ç´¢å¼•)
 * 
 * ### ä¸‰é‡æ•°å€¼ç»“æ„ (Triple-Value) - å®«ä½å åŠ åœºæ™¯
 * - `value`: åŸå§‹æ„ä¹‰ (å¦‚"èº«å®«"ã€"å¤§è´¢"ã€"å¹´å‘½")
 * - `index`: æ¸²æŸ“ä½ç½® (å®é™…æ‰€åœ¨å®«ä½ç´¢å¼•)
 * - `name`: å åŠ è¯´æ˜ (å¦‚"èº«å®«åœ¨ç–¾å„å®«")
 * 
 * éœ€è¦ä¸‰é‡æ•°å€¼çš„åœºæ™¯ï¼šèº«å®«ã€ä¸»æ˜Ÿã€è¾…æ˜Ÿã€å››åŒ–ã€å¤§è¿ã€æµå¹´ã€æ¥å› å®«
 * 
 * @version 2.0.0
 * @lastUpdated 2025-01-03
 */

/**
 * ğŸ—‚ï¸ å‡½æ•°ç´¢å¼• (Function Index)
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * ## ğŸ“š æ•°æ®è½¬æ¢ä¸é¢„å¤„ç† (Data Conversion & Preprocessing)
 * â”œâ”€â”€ createBaZiParams()              - ä»tyme4tsåˆ›å»ºç»Ÿä¸€å…«å­—å‚æ•°å¯¹è±¡ â­ æ¨èå…¥å£
 * â””â”€â”€ calculateYearGanZhi()           - è®¡ç®—å¹´å¹²æ”¯ [DEPRECATED: ä½¿ç”¨tyme4ts]
 * 
 * ## ğŸ›ï¸ å®«ä½è®¡ç®— (Palace Calculations)
 * â”œâ”€â”€ calculateLifePalace()           - è®¡ç®—å‘½å®«ä½ç½®
 * â”œâ”€â”€ calculateBodyPalace()           - è®¡ç®—èº«å®«ä½ç½®
 * â”œâ”€â”€ getPalaceName()                 - è·å–å®«ä½åç§°
 * â””â”€â”€ calculateLaiyinPalace()         - è®¡ç®—æ¥å› å®«
 * 
 * ## ğŸŒŸ ä¸»æ˜Ÿå®‰æ˜Ÿ (Main Star Placements)
 * â”œâ”€â”€ calculateZiweiPosition()        - è®¡ç®—ç´«å¾®æ˜Ÿä½ç½®
 * â”œâ”€â”€ calculateTianfuPosition()       - è®¡ç®—å¤©åºœæ˜Ÿä½ç½®
 * â””â”€â”€ calculateMainStarPositions()    - è®¡ç®—æ‰€æœ‰ä¸»æ˜Ÿä½ç½®
 * 
 * ## â­ è¾…æ˜Ÿå®‰æ˜Ÿ (Auxiliary Star Placements)
 * â”œâ”€â”€ calculateAuxiliaryStarPositions() - è®¡ç®—å‰æ˜Ÿä½ç½® (æ–‡æ˜Œæ–‡æ›²å·¦è¾…å³å¼¼ç­‰)
 * â”œâ”€â”€ calculateMaleficStarPositions()  - è®¡ç®—ç…æ˜Ÿä½ç½® (æ“ç¾Šé™€ç½—ç«é“ƒç©ºåŠ«ç­‰)
 * â”œâ”€â”€ calculateRomanceStarPositions()  - è®¡ç®—æ¡ƒèŠ±æ˜Ÿä½ç½® (çº¢é¸¾å¤©å–œå¤©å§šå’¸æ± )
 * â””â”€â”€ calculateMinorStarPositions()    - è®¡ç®—å°æ˜Ÿä½ç½® (å¤©å®˜å¤©ç¦ç­‰)
 * 
 * ## ğŸ”„ å››åŒ–è®¡ç®— (Four Transformations)
 * â”œâ”€â”€ calculateBirthYearSihua()       - è®¡ç®—ç”Ÿå¹´å››åŒ–
 * â”œâ”€â”€ calculateFlyingPalaceSihua()    - è®¡ç®—é£å®«å››åŒ–
 * â””â”€â”€ calculateSelfTransformations()  - è®¡ç®—è‡ªåŒ– (å®«å¹²å¼•å‘çš„å››åŒ–)
 * 
 * ## ğŸ‘‘ å‘½ä¸»èº«ä¸» (Life & Body Masters)
 * â”œâ”€â”€ calculateMasters()              - è®¡ç®—å‘½ä¸»èº«ä¸»
 * â””â”€â”€ getInnateDauPalaceIndex()       - è·å–å…ˆå¤©æ–—å›å®«ä½ç´¢å¼•
 * 
 * ## ğŸ“… è¿ç¨‹è®¡ç®— (Period Calculations)
 * â”œâ”€â”€ calculateMajorPeriodStartAge()  - è®¡ç®—å¤§è¿èµ·è¿å¹´é¾„
 * â”œâ”€â”€ calculateMajorPeriods()         - è®¡ç®—å¤§è¿ä¿¡æ¯
 * â”œâ”€â”€ calculateFleetingYears()        - è®¡ç®—æµå¹´
 * â””â”€â”€ calculateMinorPeriod()          - è®¡ç®—å°é™
 * 
 
 * ## âš¡ äº”è¡Œå±€ (Five Elements Bureau)
 * â””â”€â”€ calculateFiveElementsBureauDetail() - äº”è¡Œå±€è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…å«æ‰€æœ‰æ ¼å¼ï¼‰
 * 
 * ## ğŸŒŸ æ˜Ÿæ›œäº®åº¦ (Star Brightness)
 * â”œâ”€â”€ getStarBrightness()             - è·å–æ˜Ÿæ›œäº®åº¦å€¼ â­ æ¨è
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * @usage æ¨èä½¿ç”¨æ¨¡å¼ï¼š
 * ```typescript
 * import { Solar } from 'tyme4ts'
 * import { createBaZiParams } from './calculations'
 * 
 * const solar = Solar.fromYmd(1989, 2, 1)
 * const baziParams = createBaZiParams(solar, 0) // ç»Ÿä¸€æ•°æ®å…¥å£
 * 
 * // ä½¿ç”¨ baziParams ä¸­çš„æ•°æ®è¿›è¡Œå„ç§è®¡ç®—
 * const lifePalace = calculateLifePalace(baziParams.lunarMonth, baziParams.timeZhiIndex)
 * ```
 * 
 * @note
 * - â­ æ ‡è®°ä¸ºæ¨èä½¿ç”¨çš„å‡½æ•°
 * - [DEPRECATED] æ ‡è®°ä¸ºå³å°†åºŸå¼ƒçš„å‡½æ•°
 * - æ–°é¡¹ç›®è¯·ä¼˜å…ˆä½¿ç”¨ createBaZiParams ä½œä¸ºæ•°æ®å…¥å£
 */

import {
  // Basic elements
  STEMS,
  BRANCHES,
  PALACE_NAMES,
  
  // Five elements bureau
  FIVE_ELEMENTS_BUREAU,
  BUREAU_CODE_TO_COLUMN,
  MAJOR_PERIOD_START_AGE,
  
  // Star systems
  ZIWEI_POSITION_TABLE,
  TIANFU_OFFSET_FROM_ZIWEI,
  
  // Master stars and sihua
  BIRTH_YEAR_SIHUA,
  FLYING_PALACE_SIHUA,
  LIFE_MASTER_STARS,
  BODY_MASTER_STARS,
  
  // Star brightness
  STAR_BRIGHTNESS_TABLE,
  STAR_BRIGHTNESS,
  BRIGHTNESS_LEVEL_MAP,
  
  // Types
  type StarBrightnessValue
} from './constants'

import { SolarDay, SolarTime } from 'tyme4ts'
import { getMinorLimit } from './time-calculations'

/**
 * ç»Ÿä¸€å…«å­—å‚æ•°ç»“æ„
 * Unified BaZi (Eight Characters) parameter structure
 * 
 * @description
 * ä» tyme4ts çš„å…«å­—å¯¹è±¡ä¸­æå–æ‰€æœ‰ç´«å¾®æ–—æ•°è®¡ç®—æ‰€éœ€çš„åŸºç¡€æ•°æ®ï¼Œ
 * ç¡®ä¿æ‰€æœ‰è®¡ç®—éƒ½åŸºäºå‡†ç¡®çš„å†œå†å’ŒèŠ‚æ°”ä¿¡æ¯ã€‚
 * 
 * Extract all essential data for ZiWei calculations from tyme4ts BaZi object,
 * ensuring all calculations are based on accurate lunar calendar and solar term information.
 * 
 * @example
 * ```typescript
 * import { Solar } from 'tyme4ts'
 * 
 * // ç¤ºä¾‹ 1: 1989å¹´2æœˆ1æ—¥ (ç«‹æ˜¥å‰ï¼Œå¹´å¹²æ”¯ä»ä¸º1988å¹´)
 * const solar1 = Solar.fromYmd(1989, 2, 1)
 * const baziParams1 = createBaZiParams(solar1)
 * // baziParams1.yearStem = 'æˆŠ', baziParams1.yearBranch = 'è¾°' (1988å¹´å¹²æ”¯)
 * 
 * // ç¤ºä¾‹ 2: é—°æœˆå¤„ç† (tyme4ts è‡ªåŠ¨è¯†åˆ«é—°æœˆ)
 * const solar2 = Solar.fromYmd(2023, 4, 10) // å‡è®¾ä¸ºé—°äºŒæœˆ
 * const baziParams2 = createBaZiParams(solar2)
 * // baziParams2.isLeapMonth = true/false, lunarMonth = å®é™…å†œå†æœˆä»½
 * 
 * // æ¨èç”¨æ³•ï¼šç›´æ¥ä½¿ç”¨ createBaZiParams è€Œä¸æ˜¯æ‰‹åŠ¨æ„å»º
 * const baziParams: BaZiParams = createBaZiParams(solar1)
 * ```
 */
export interface BaZiParams {
  /** å¹´å¹² (ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸) */
  yearStem: string
  /** å¹´æ”¯ (å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥) */
  yearBranch: string
  /** æœˆå¹² */
  monthStem: string
  /** æœˆæ”¯ */
  monthBranch: string
  /** æ—¥å¹² */
  dayStem: string
  /** æ—¥æ”¯ */
  dayBranch: string
  /** æ—¶å¹² */
  timeStem: string
  /** æ—¶æ”¯ */
  timeBranch: string
  /** å†œå†æœˆä»½ (1-12) */
  lunarMonth: number
  /** å†œå†æ—¥æœŸ (1-30) */
  lunarDay: number
  /** æ˜¯å¦é—°æœˆ */
  isLeapMonth: boolean
  /** æ—¶æ”¯ç´¢å¼• (0-11ï¼Œå¯¹åº”å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥) */
  timeZhiIndex: number
  /** å¤§è¿å¹²æ”¯æ•°ç»„ (8ç»„å¤§è¿ï¼Œæ¯ç»„10å¹´) */
  majorPeriods: Array<{
    stem: string
    branch: string
    startAge: number
    endAge: number
  }>
  /** èµ·è¿å²æ•° (è™šå²) */
  startMajorPeriodAge: number
  /** èµ·è¿è¯¦ç»†æ—¶é—´ä¿¡æ¯ */
  qiyunDetail: {
    years: number
    months: number  
    days: number
  }
}

/**
 * ä» tyme4ts åˆ›å»º BaZi å‚æ•°å¯¹è±¡
 * Create BaZi parameters from tyme4ts objects
 * 
 * @description
 * æ­¤å‡½æ•°æ˜¯æ‰€æœ‰ç´«å¾®æ–—æ•°è®¡ç®—çš„å…¥å£ç‚¹ï¼Œç¡®ä¿æ•°æ®çš„å‡†ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚
 * This function is the entry point for all ZiWei calculations, ensuring data accuracy and consistency.
 * 
 * @param solar tyme4ts Solar å¯¹è±¡
 * @param gender æ€§åˆ« (0=ç”·æ€§ï¼Œ1=å¥³æ€§ï¼Œå½±å“å¤§è¿èµ·è¿æ–¹å‘)
 * @returns BaZiParams åŒ…å«æ‰€æœ‰è®¡ç®—æ‰€éœ€çš„åŸºç¡€æ•°æ®
 * 
 * @example
 * ```typescript
 * import { Solar } from 'tyme4ts'
 * const solar = Solar.fromYmd(1989, 2, 1)
 * const baziParams = createBaZiParams(solar, 0) // 0=ç”·æ€§
 * // baziParams.yearStem = 'æˆŠ', baziParams.yearBranch = 'è¾°' (æ­£ç¡®å¤„ç†ç«‹æ˜¥åˆ†ç•Œ)
 * // baziParams.majorPeriods = 8ç»„å¤§è¿å¹²æ”¯ï¼Œèµ·è¿æ–¹å‘æ ¹æ®æ€§åˆ«è‡ªåŠ¨è®¡ç®—
 * ```
 */
export function createBaZiParams(solarTime: any, gender: number = 0): BaZiParams {
  const { ChildLimit, Gender } = require('tyme4ts')
  
  const solar = solarTime.getSolarDay()
  const lunar = solar.getLunarDay()
  
  // ä»tyme4tsè·å–å¹²æ”¯ä¿¡æ¯
  const yearSixtyCycle = lunar.getYearSixtyCycle()
  const monthSixtyCycle = lunar.getMonthSixtyCycle()
  const daySixtyCycle = lunar.getSixtyCycle()
  
  // ä»SixtyCycleå¯¹è±¡ä¸­æå–å¹²æ”¯åç§°
  const yearGanZhi = yearSixtyCycle.names[yearSixtyCycle.index].split('')
  const monthGanZhi = monthSixtyCycle.names[monthSixtyCycle.index].split('')
  const dayGanZhi = daySixtyCycle.names[daySixtyCycle.index].split('')
  
  // è·å–æ—¶è¾°å¹²æ”¯ï¼ˆéœ€è¦ä»å°æ—¶è®¡ç®—ï¼‰
  const hour = solarTime.getHour()
  const timeZhiIndex = Math.floor((hour + 1) / 2) % 12
  const timeBranch = BRANCHES[timeZhiIndex]
  
  // è®¡ç®—æ—¶è¾°å¤©å¹²ï¼ˆæ—¶å¹²æ ¹æ®æ—¥å¹²æ¨ç®—ï¼Œäº”é¼ éæ³•ï¼‰
  const dayStemIndex = STEMS.indexOf(dayGanZhi[0])
  const timeStemIndex = (dayStemIndex % 5 * 2 + timeZhiIndex) % 10
  const timeStem = STEMS[timeStemIndex]
  
  // ä½¿ç”¨tyme4tsçš„ChildLimitç«¥é™è®¡ç®—èµ·è¿å’Œå¤§è¿ï¼
  const childLimit = ChildLimit.fromSolarTime(solarTime, gender === 0 ? Gender.MAN : Gender.WOMAN)
  
  // è·å–è¯¦ç»†çš„èµ·è¿æ—¶é—´ï¼ˆå¹´ã€æœˆã€æ—¥ï¼‰
  const qiyunYears = childLimit.getYearCount()
  const qiyunMonths = childLimit.getMonthCount() 
  const qiyunDays = childLimit.getDayCount()
  
  // èµ·è¿å¹´é¾„æ˜¯ç«¥é™ç»“æŸçš„å¹´é¾„
  const startAge = childLimit.getEndAge()
  
  // ä»èµ·å§‹å¤§è¿å¼€å§‹ï¼Œæ‰‹åŠ¨è®¡ç®—åç»­å¤§è¿
  const majorPeriods = []
  const startDecadeFortune = childLimit.getStartDecadeFortune()
  const startSixtyCycle = startDecadeFortune.getSixtyCycle()
  const startGanZhi = startSixtyCycle.names[startSixtyCycle.index].split('')
  
  // æ·»åŠ ç¬¬ä¸€ä¸ªå¤§è¿
  majorPeriods.push({
    stem: startGanZhi[0],
    branch: startGanZhi[1], 
    startAge: startDecadeFortune.getStartAge(),
    endAge: startDecadeFortune.getEndAge()
  })
  
  // æ ¹æ®é¡ºé€†è¡Œæ–¹å‘è®¡ç®—åç»­7ä¸ªå¤§è¿
  const isForward = childLimit.isForward()
  const startSixtyCycleIndex = startSixtyCycle.index
  
  // åˆ›å»ºå®Œæ•´çš„60ç”²å­æ•°ç»„ä»¥ä¾¿è®¡ç®—
  const allSixtyCycle = [
    'ç”²å­', 'ä¹™ä¸‘', 'ä¸™å¯…', 'ä¸å¯', 'æˆŠè¾°', 'å·±å·³', 'åºšåˆ', 'è¾›æœª', 'å£¬ç”³', 'ç™¸é…‰',
    'ç”²æˆŒ', 'ä¹™äº¥', 'ä¸™å­', 'ä¸ä¸‘', 'æˆŠå¯…', 'å·±å¯', 'åºšè¾°', 'è¾›å·³', 'å£¬åˆ', 'ç™¸æœª',
    'ç”²ç”³', 'ä¹™é…‰', 'ä¸™æˆŒ', 'ä¸äº¥', 'æˆŠå­', 'å·±ä¸‘', 'åºšå¯…', 'è¾›å¯', 'å£¬è¾°', 'ç™¸å·³',
    'ç”²åˆ', 'ä¹™æœª', 'ä¸™ç”³', 'ä¸é…‰', 'æˆŠæˆŒ', 'å·±äº¥', 'åºšå­', 'è¾›ä¸‘', 'å£¬å¯…', 'ç™¸å¯',
    'ç”²è¾°', 'ä¹™å·³', 'ä¸™åˆ', 'ä¸æœª', 'æˆŠç”³', 'å·±é…‰', 'åºšæˆŒ', 'è¾›äº¥', 'å£¬å­', 'ç™¸ä¸‘',
    'ç”²å¯…', 'ä¹™å¯', 'ä¸™è¾°', 'ä¸å·³', 'æˆŠåˆ', 'å·±æœª', 'åºšç”³', 'è¾›é…‰', 'å£¬æˆŒ', 'ç™¸äº¥'
  ]
  
  for (let i = 1; i < 8; i++) {
    let nextIndex
    if (isForward) {
      // é¡ºè¡Œï¼šä»ç¬¬ä¸€ä¸ªå¤§è¿å¼€å§‹+i
      nextIndex = (startSixtyCycleIndex + i) % 60
    } else {
      // é€†è¡Œï¼šä»ç¬¬ä¸€ä¸ªå¤§è¿å¼€å§‹-i  
      nextIndex = (startSixtyCycleIndex - i + 60) % 60
    }
    
    const nextGanZhi = allSixtyCycle[nextIndex].split('')
    majorPeriods.push({
      stem: nextGanZhi[0],
      branch: nextGanZhi[1],
      startAge: majorPeriods[0].startAge + i * 10,
      endAge: majorPeriods[0].startAge + i * 10 + 9
    })
  }

  return {
    yearStem: yearGanZhi[0],
    yearBranch: yearGanZhi[1],
    monthStem: monthGanZhi[0],
    monthBranch: monthGanZhi[1],
    dayStem: dayGanZhi[0],
    dayBranch: dayGanZhi[1],
    timeStem: timeStem,
    timeBranch: timeBranch,
    lunarMonth: lunar.getMonth(),
    lunarDay: lunar.getDay(),
    isLeapMonth: lunar.getLunarMonth().isLeap(),
    timeZhiIndex: timeZhiIndex,
    // å…«å­—èµ·è¿å’Œå¤§è¿ä¿¡æ¯ï¼ˆæ¥è‡ªtyme4ts ChildLimit APIï¼‰
    majorPeriods: majorPeriods,
    startMajorPeriodAge: startAge,
    qiyunDetail: {
      years: qiyunYears,
      months: qiyunMonths,
      days: qiyunDays
    }
  }
}

// å·²åˆ é™¤æ‰‹åŠ¨è®¡ç®—å‡½æ•°ï¼Œç°åœ¨ä½¿ç”¨tyme4tsçš„ChildLimit APIè·å–å‡†ç¡®çš„å…«å­—èµ·è¿å’Œå¤§è¿ä¿¡æ¯

/**
 * è®¡ç®—å¹´å¹²æ”¯
 * Calculate year stem and branch
 */
/**
 * @deprecated å»ºè®®ä½¿ç”¨ tyme4ts çš„å…«å­—åŠŸèƒ½æ›¿ä»£æ­¤å‡½æ•°
 * @deprecated Use tyme4ts eight-character (å…«å­—) functionality instead
 * 
 * âš ï¸ é‡è¦å‡†ç¡®æ€§é—®é¢˜ï¼šæ­¤å‡½æ•°ä½¿ç”¨ç®€å•æ•°å­¦è®¡ç®—ï¼Œå¿½ç•¥äº†å†œå†å¹´å¹²æ”¯ä»¥ç«‹æ˜¥ä¸ºåˆ†ç•Œçš„è§„åˆ™ï¼
 * âš ï¸ CRITICAL ACCURACY ISSUE: This function uses simple math calculation and ignores 
 * the rule that lunar year stem-branch changes at ç«‹æ˜¥ (Start of Spring), not Jan 1st!
 * 
 * ä¾‹å¦‚ï¼š1989å¹´2æœˆ1æ—¥çš„å¹´å¹²æ”¯åº”è¯¥æ˜¯1988å¹´çš„"æˆŠè¾°"ï¼Œè€Œä¸æ˜¯1989å¹´çš„"å·±å·³"
 * Example: Feb 1, 1989 should have year stem-branch "æˆŠè¾°" (1988), not "å·±å·³" (1989)
 * 
 * tyme4ts æä¾›åŸºäºèŠ‚æ°”çš„ç²¾ç¡®è®¡ç®—ï¼Œé¿å…æ­¤ç±»è¯¯å·®ã€‚
 * tyme4ts provides precise calculations based on solar terms, avoiding such errors.
 * 
 * æ¨èä½¿ç”¨ï¼š
 * Recommended usage:
 * ```typescript
 * import { Solar, LunarYear } from 'tyme4ts'
 * const solar = Solar.fromYmd(1989, 2, 1)
 * const lunar = solar.getLunar()
 * const ganZhi = lunar.getYearGanZhi() // æ­£ç¡®è¿”å› "æˆŠè¾°"
 * ```
 */
export function calculateYearGanZhi(year: number): { stem: string; branch: string } {
  const stemIndex = (year - 4) % 10
  const branchIndex = (year - 4) % 12
  return {
    stem: STEMS[stemIndex],
    branch: BRANCHES[branchIndex]
  }
}

/**
 * è®¡ç®—å‘½å®«ä½ç½®
 * Calculate Life Palace position
 * 
 * @description
 * ç´«å¾®æ–—æ•°æ ‡å‡†ç®—æ³•ï¼š
 * 1. ä»å¯…å®«èµ·æ­£æœˆï¼Œé¡ºæ•°åˆ°å‡ºç”Ÿæœˆä»½
 * 2. ä»è¯¥å®«èµ·å­æ—¶ï¼Œé€†æ•°åˆ°å‡ºç”Ÿæ—¶è¾°
 * 3. æ‰€å¾—å®«ä½å³ä¸ºå‘½å®«
 * 
 * @param month å†œå†ç”Ÿæœˆ (1-12)
 * @param timeZhiIndex æ—¶è¾°ç´¢å¼• (0-11: å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥)
 * @returns å‘½å®«å®«ä½ç´¢å¼• (0-11)
 */
export function calculateLifePalace(month: number, timeZhiIndex: number): number {
  // å¯…å®«ç´¢å¼•ä¸º2ï¼Œä»å¯…å®«èµ·æ­£æœˆé¡ºæ•°åˆ°å‡ºç”Ÿæœˆ
  const monthPalace = (2 + month - 1) % 12
  
  // ä»æœˆå®«èµ·å­æ—¶(0)ï¼Œé€†æ•°åˆ°å‡ºç”Ÿæ—¶è¾°
  // é€†æ•°å°±æ˜¯å‡æ³•
  let lifePalace = (monthPalace - timeZhiIndex + 12) % 12
  
  return lifePalace
}

/**
 * è®¡ç®—èº«å®«ä½ç½®
 * Calculate Body Palace position
 * 
 * @description
 * ç´«å¾®æ–—æ•°æ ‡å‡†ç®—æ³•ï¼š
 * 1. ä»å¯…å®«èµ·æ­£æœˆï¼Œé¡ºæ•°åˆ°å‡ºç”Ÿæœˆä»½
 * 2. ä»è¯¥å®«èµ·å­æ—¶ï¼Œé¡ºæ•°åˆ°å‡ºç”Ÿæ—¶è¾°
 * 3. æ‰€å¾—å®«ä½å³ä¸ºèº«å®«
 * 
 * @param month å†œå†ç”Ÿæœˆ (1-12)
 * @param timeZhiIndex æ—¶è¾°ç´¢å¼• (0-11: å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥)
 * @returns èº«å®«å®«ä½ç´¢å¼• (0-11)
 */
export function calculateBodyPalace(month: number, timeZhiIndex: number): number {
  // å¯…å®«ç´¢å¼•ä¸º2ï¼Œä»å¯…å®«èµ·æ­£æœˆé¡ºæ•°åˆ°å‡ºç”Ÿæœˆ
  const monthPalace = (2 + month - 1) % 12
  
  // ä»æœˆå®«èµ·å­æ—¶(0)ï¼Œé¡ºæ•°åˆ°å‡ºç”Ÿæ—¶è¾°
  // é¡ºæ•°å°±æ˜¯åŠ æ³•
  let bodyPalace = (monthPalace + timeZhiIndex) % 12
  
  return bodyPalace
}

/**
 * è®¡ç®—ç´«å¾®æ˜Ÿä½ç½®
 * Calculate ZiWei star position
 * 
 * @param bureauCode äº”è¡Œå±€ä»£ç  (å¦‚ "fire_6", "water_2")
 * @param day å†œå†æ—¥ (1-30)
 * @returns ç´«å¾®æ˜Ÿæ‰€åœ¨å®«ä½ç´¢å¼• (0-11)
 */
export function calculateZiweiPosition(bureauCode: string, day: number): number {
  
  // è·å–äº”è¡Œå±€å¯¹åº”çš„åˆ—ç´¢å¼•
  const columnIndex = BUREAU_CODE_TO_COLUMN[bureauCode]
  
  // è¾“å…¥éªŒè¯
  if (columnIndex === undefined) {
    throw new Error(`Invalid bureau code: ${bureauCode}`)
  }
  if (day < 1 || day > 30) {
    throw new Error(`Invalid day: ${day}. Must be between 1 and 30`)
  }
  
  // ä»è¡¨ä¸­è·å–ç´«å¾®æ˜Ÿä½ç½®ï¼ˆåœ°æ”¯åç§°ï¼‰
  const rowIndex = day - 1 // è½¬æ¢ä¸º0-basedç´¢å¼•
  const positionBranch = ZIWEI_POSITION_TABLE[rowIndex]?.[columnIndex]
  
  if (!positionBranch) {
    // å¦‚æœè¶…å‡ºè¡¨æ ¼èŒƒå›´ï¼Œä½¿ç”¨é»˜è®¤ç®—æ³•
    return Math.floor((day - 1) / 3) % 12
  }
  
  // å°†åœ°æ”¯åç§°è½¬æ¢ä¸ºç´¢å¼•
  const positionIndex = BRANCHES.indexOf(positionBranch)
  
  if (positionIndex === -1) {
    throw new Error(`Could not find branch index for: ${positionBranch}`)
  }
  
  return positionIndex
}

/**
 * è®¡ç®—å¤©åºœæ˜Ÿä½ç½®
 * Calculate TianFu star position
 */
export function calculateTianfuPosition(ziweiPosition: number): number {
  const offset = TIANFU_OFFSET_FROM_ZIWEI[ziweiPosition]
  return (ziweiPosition + offset) % 12
}

/**
 * è®¡ç®—åå››ä¸»æ˜Ÿä½ç½®
 * Calculate positions of 14 main stars
 */
export function calculateMainStarPositions(
  ziweiPos: number,
  tianfuPos: number
): Map<string, number[]> {
  const positions = new Map<string, number[]>()
  
  // ç´«å¾®ç³»åˆ—
  positions.set('ç´«å¾®', [ziweiPos])
  positions.set('å¤©æœº', [(ziweiPos + 11) % 12])
  positions.set('å¤ªé˜³', [(ziweiPos + 9) % 12])
  positions.set('æ­¦æ›²', [(ziweiPos + 8) % 12])
  positions.set('å¤©åŒ', [(ziweiPos + 7) % 12])
  positions.set('å»‰è´', [(ziweiPos + 4) % 12])
  
  // å¤©åºœç³»åˆ—
  positions.set('å¤©åºœ', [tianfuPos])
  positions.set('å¤ªé˜´', [(tianfuPos + 1) % 12])
  positions.set('è´ªç‹¼', [(tianfuPos + 2) % 12])
  positions.set('å·¨é—¨', [(tianfuPos + 3) % 12])
  positions.set('å¤©ç›¸', [(tianfuPos + 4) % 12])
  positions.set('å¤©æ¢', [(tianfuPos + 5) % 12])
  positions.set('ä¸ƒæ€', [(tianfuPos + 6) % 12])
  positions.set('ç ´å†›', [(tianfuPos + 10) % 12])
  
  return positions
}

/**
 * è®¡ç®—è¾…æ˜Ÿä½ç½®ï¼ˆå‰æ˜Ÿç±»ï¼‰
 * Calculate auxiliary star positions (Auspicious stars)
 * 
 * @ai-context è¾…æ˜ŸåŒ…å«ï¼šæ–‡æ˜Œã€æ–‡æ›²ã€å·¦è¾…ã€å³å¼¼ã€å¤©é­ã€å¤©é’ºã€ç¦„å­˜ã€å¤©é©¬
 * - æ–‡æ˜Œï¼ˆæ™‚ç³»æ˜Ÿï¼‰ï¼šä»æˆŒå®«èµ·å­æ—¶ï¼Œé€†æ—¶é’ˆæ•°åˆ°å‡ºç”Ÿæ—¶è¾°
 * - æ–‡æ›²ï¼ˆæ™‚ç³»æ˜Ÿï¼‰ï¼šä»è¾°å®«èµ·å­æ—¶ï¼Œé¡ºæ—¶é’ˆæ•°åˆ°å‡ºç”Ÿæ—¶è¾°
 * - å·¦è¾…ï¼ˆæœˆç³»æ˜Ÿï¼‰ï¼šä»è¾°å®«èµ·æ­£æœˆï¼Œé¡ºæ—¶é’ˆæ•°åˆ°å‡ºç”Ÿæœˆä»½
 * - å³å¼¼ï¼ˆæœˆç³»æ˜Ÿï¼‰ï¼šä»æˆŒå®«èµ·æ­£æœˆï¼Œé€†æ—¶é’ˆæ•°åˆ°å‡ºç”Ÿæœˆä»½
 * 
 * @param month å†œå†æœˆ (1-12)
 * @param day å†œå†æ—¥ (1-30)
 * @param timeZhiIndex æ—¶è¾°ç´¢å¼• (0-11, 0=å­æ—¶)
 * @param yearStem å¹´å¹²
 * @param yearBranch å¹´æ”¯
 */
export function calculateAuxiliaryStarPositions(
  month: number,
  day: number,
  timeZhiIndex: number,
  yearStem: string,
  yearBranch: string,
  lifePalaceIndex?: number
): Map<string, number[]> {
  const positions = new Map<string, number[]>()
  const yearBranchIndex = BRANCHES.indexOf(yearBranch as any)
  
  // æ–‡æ˜Œæ˜Ÿ - æ ¹æ®å¹´å¹²æŸ¥è¡¨
  const wenchangTable: Record<string, number> = {
    'ç”²': 5,   // å·³
    'ä¹™': 6,   // åˆ
    'ä¸™': 8,   // ç”³
    'ä¸': 9,   // é…‰
    'æˆŠ': 8,   // ç”³
    'å·±': 9,   // é…‰
    'åºš': 11,  // äº¥
    'è¾›': 0,   // å­
    'å£¬': 2,   // å¯…
    'ç™¸': 3    // å¯
  }
  const wenchangPos = wenchangTable[yearStem] ?? 0
  positions.set('æ–‡æ˜Œ', [wenchangPos])
  
  // æ–‡æ›²æ˜Ÿ - ä»è¾°å®«ï¼ˆç´¢å¼•4ï¼‰èµ·å­æ—¶ï¼Œé¡ºæ—¶é’ˆæ•°åˆ°å‡ºç”Ÿæ—¶è¾°
  // è¾°å®«èµ·ç‚¹ï¼Œé¡ºè¡Œï¼šè¾°(4) -> å·³(5) -> åˆ(6) -> ...
  const wenquPos = (4 + timeZhiIndex) % 12
  positions.set('æ–‡æ›²', [wenquPos])
  
  // å·¦è¾…æ˜Ÿ - ä»è¾°å®«ï¼ˆç´¢å¼•4ï¼‰èµ·æ­£æœˆï¼Œé¡ºæ—¶é’ˆæ•°åˆ°å‡ºç”Ÿæœˆä»½
  // è¾°å®«èµ·ç‚¹ï¼Œé¡ºè¡Œï¼šè¾°(4) -> å·³(5) -> åˆ(6) -> ...
  // monthæ˜¯1-12ï¼Œéœ€è¦å‡1ä½œä¸ºåç§»é‡
  const zuofuPos = (4 + (month - 1)) % 12
  positions.set('å·¦è¾…', [zuofuPos])
  
  // å³å¼¼æ˜Ÿ - ä»æˆŒå®«ï¼ˆç´¢å¼•10ï¼‰èµ·æ­£æœˆï¼Œé€†æ—¶é’ˆæ•°åˆ°å‡ºç”Ÿæœˆä»½
  // æˆŒå®«èµ·ç‚¹ï¼Œé€†è¡Œï¼šæˆŒ(10) -> é…‰(9) -> ç”³(8) -> ...
  // monthæ˜¯1-12ï¼Œéœ€è¦å‡1ä½œä¸ºåç§»é‡
  const youbiPos = (10 - (month - 1) + 12) % 12
  positions.set('å³å¼¼', [youbiPos])
  
  // å¤©é­å¤©é’º - æ ¹æ®å¹´å¹²
  const kuiYueTable: Record<string, [number, number]> = {
    'ç”²': [1, 7],  // ä¸‘æœª
    'æˆŠ': [1, 7],  // ä¸‘æœª
    'åºš': [1, 7],  // ä¸‘æœª
    'ä¹™': [0, 8],  // å­ç”³
    'å·±': [0, 8],  // å­ç”³
    'ä¸™': [11, 9], // äº¥é…‰
    'ä¸': [11, 9], // äº¥é…‰
    'è¾›': [6, 2],  // åˆå¯…
    'å£¬': [3, 5],  // å¯å·³
    'ç™¸': [3, 5]   // å¯å·³
  }
  
  const [kuiPos, yuePos] = kuiYueTable[yearStem] || [0, 6]
  positions.set('å¤©é­', [kuiPos])
  positions.set('å¤©é’º', [yuePos])
  
  // ç¦„å­˜ - æ ¹æ®å¹´å¹²
  const lucunTable: Record<string, number> = {
    'ç”²': 2,  // å¯…
    'ä¹™': 3,  // å¯
    'ä¸™': 5,  // å·³
    'æˆŠ': 5,  // å·³
    'ä¸': 6,  // åˆ
    'å·±': 6,  // åˆ
    'åºš': 8,  // ç”³
    'è¾›': 9,  // é…‰
    'å£¬': 11, // äº¥
    'ç™¸': 0   // å­
  }
  
  const lucunPos = lucunTable[yearStem] || 0
  positions.set('ç¦„å­˜', [lucunPos])
  
  // å¤©é©¬ - æ ¹æ®ç”Ÿå¹´åœ°æ”¯
  // è§„åˆ™ï¼š
  // ç”³å­è¾°å¹´ï¼ˆçŒ´é¼ é¾™ï¼‰-> å¯…å®«
  // äº¥å¯æœªå¹´ï¼ˆçŒªå…”ç¾Šï¼‰-> å·³å®«  
  // å¯…åˆæˆŒå¹´ï¼ˆè™é©¬ç‹—ï¼‰-> ç”³å®«
  // å·³é…‰ä¸‘å¹´ï¼ˆè›‡é¸¡ç‰›ï¼‰-> äº¥å®«
  const tianmaTable: Record<number, number> = {
    0: 2,   // å­(é¼ )å¹´åœ¨å¯…å®«
    1: 11,  // ä¸‘(ç‰›)å¹´åœ¨äº¥å®«
    2: 8,   // å¯…(è™)å¹´åœ¨ç”³å®«
    3: 5,   // å¯(å…”)å¹´åœ¨å·³å®«
    4: 2,   // è¾°(é¾™)å¹´åœ¨å¯…å®«
    5: 11,  // å·³(è›‡)å¹´åœ¨äº¥å®«
    6: 8,   // åˆ(é©¬)å¹´åœ¨ç”³å®«
    7: 5,   // æœª(ç¾Š)å¹´åœ¨å·³å®«
    8: 2,   // ç”³(çŒ´)å¹´åœ¨å¯…å®«
    9: 11,  // é…‰(é¸¡)å¹´åœ¨äº¥å®«
    10: 8,  // æˆŒ(ç‹—)å¹´åœ¨ç”³å®«
    11: 5   // äº¥(çŒª)å¹´åœ¨å·³å®«
  }
  
  const tianmaPos = tianmaTable[yearBranchIndex] || 0
  positions.set('å¤©é©¬', [tianmaPos])
  
  return positions
}

/**
 * è®¡ç®—ç…æ˜Ÿä½ç½®
 * Calculate malefic star positions
 * 
 * @ai-context ç…æ˜ŸåŒ…å«ï¼šæ“ç¾Šã€é™€ç½—ã€ç«æ˜Ÿã€é“ƒæ˜Ÿã€åœ°ç©ºã€åœ°åŠ«ã€å¤©åˆ‘
 * 
 * @param month å†œå†æœˆ (1-12)
 * @param timeZhiIndex æ—¶è¾°ç´¢å¼• (0-11)
 * @param yearStem å¹´å¹²
 * @param yearBranch å¹´æ”¯
 */
export function calculateMaleficStarPositions(
  month: number,
  timeZhiIndex: number,
  yearStem: string,
  yearBranch: string
): Map<string, number[]> {
  const positions = new Map<string, number[]>()
  
  // æ“ç¾Šé™€ç½— - æ ¹æ®å¹´å¹²
  const yangTuoTable: Record<string, [number, number]> = {
    'ç”²': [3, 1],  // å¯ä¸‘
    'ä¹™': [4, 2],  // è¾°å¯…
    'ä¸™': [6, 4],  // åˆè¾°
    'æˆŠ': [6, 4],  // åˆè¾°
    'ä¸': [7, 5],  // æœªå·³
    'å·±': [7, 5],  // æœªå·³
    'åºš': [9, 7],  // é…‰æœª
    'è¾›': [10, 8], // æˆŒç”³
    'å£¬': [0, 10], // å­æˆŒ
    'ç™¸': [1, 11]  // ä¸‘äº¥
  }
  
  const [yangPos, tuoPos] = yangTuoTable[yearStem] || [0, 2]
  positions.set('æ“ç¾Š', [yangPos])
  positions.set('é™€ç½—', [tuoPos])
  
  // ç«æ˜Ÿ - æ ¹æ®å¹´æ”¯ç¡®å®šèµ·å§‹å®«ä½ï¼Œå†é¡ºæ•°è‡³æ—¶è¾°
  const yearBranchIndex = BRANCHES.indexOf(yearBranch as any)
  let huoxingStartPos: number
  if ([2, 6, 10].includes(yearBranchIndex)) {  // å¯…åˆæˆŒå¹´
    huoxingStartPos = 1  // ä»ä¸‘å®«èµ·
  } else if ([8, 0, 4].includes(yearBranchIndex)) {  // ç”³å­è¾°å¹´
    huoxingStartPos = 2  // ä»å¯…å®«èµ·
  } else if ([5, 9, 1].includes(yearBranchIndex)) {  // å·³é…‰ä¸‘å¹´
    huoxingStartPos = 3  // ä»å¯å®«èµ·
  } else {  // äº¥å¯æœªå¹´
    huoxingStartPos = 9  // ä»é…‰å®«èµ·
  }
  const huoxingPos = (huoxingStartPos + timeZhiIndex) % 12
  positions.set('ç«æ˜Ÿ', [huoxingPos])
  
  // é“ƒæ˜Ÿ - ç±»ä¼¼ç«æ˜Ÿä½†èµ·å§‹å®«ä½ä¸åŒï¼ˆæš‚ä¿ç•™åŸç®—æ³•ï¼Œå¾…ç¡®è®¤ï¼‰
  const bellPos = (yearBranchIndex + timeZhiIndex + 6) % 12
  positions.set('é“ƒæ˜Ÿ', [bellPos])
  
  // åœ°ç©ºåœ°åŠ« - æ ¹æ®æ—¶æ”¯
  positions.set('åœ°ç©º', [(11 - timeZhiIndex) % 12])
  positions.set('åœ°åŠ«', [(11 + timeZhiIndex) % 12])
  
  // å¤©åˆ‘ - æ ¹æ®æœˆæ”¯
  // æ­£æœˆåœ¨é…‰ï¼ŒäºŒæœˆåœ¨æˆŒ...åäºŒæœˆåœ¨ç”³
  const tianxingPos = (9 + (month - 1)) % 12
  positions.set('å¤©åˆ‘', [tianxingPos])
  
  return positions
}

/**
 * è®¡ç®—æ¡ƒèŠ±æ˜Ÿä½ç½®
 * Calculate romance star positions
 * 
 * @ai-context æ¡ƒèŠ±æ˜ŸåŒ…å«ï¼šçº¢é¸¾ã€å¤©å–œã€å¤©å§šã€å’¸æ± 
 * 
 * @param yearBranch å¹´æ”¯
 */
export function calculateRomanceStarPositions(
  yearBranch: string
): Map<string, number[]> {
  const positions = new Map<string, number[]>()
  const yearBranchIndex = BRANCHES.indexOf(yearBranch as any)
  
  // çº¢é¸¾ - æ ¹æ®å¹´æ”¯
  // å­å¹´åœ¨å¯ï¼Œä¸‘å¹´åœ¨å¯…ï¼Œå¯…å¹´åœ¨ä¸‘...
  const hongluanTable: Record<number, number> = {
    0: 3,   // å­å¹´åœ¨å¯
    1: 2,   // ä¸‘å¹´åœ¨å¯…
    2: 1,   // å¯…å¹´åœ¨ä¸‘
    3: 0,   // å¯å¹´åœ¨å­
    4: 11,  // è¾°å¹´åœ¨äº¥
    5: 10,  // å·³å¹´åœ¨æˆŒ
    6: 9,   // åˆå¹´åœ¨é…‰
    7: 8,   // æœªå¹´åœ¨ç”³
    8: 7,   // ç”³å¹´åœ¨æœª
    9: 6,   // é…‰å¹´åœ¨åˆ
    10: 5,  // æˆŒå¹´åœ¨å·³
    11: 4   // äº¥å¹´åœ¨è¾°
  }
  
  const hongluanPos = hongluanTable[yearBranchIndex] || 0
  positions.set('çº¢é¸¾', [hongluanPos])
  
  // å¤©å–œ - çº¢é¸¾å¯¹å®«
  const tianxiPos = (hongluanPos + 6) % 12
  positions.set('å¤©å–œ', [tianxiPos])
  
  // å¤©å§š - æ ¹æ®å¹´æ”¯
  // è§„å¾‹ï¼šå­å¹´åœ¨ä¸‘ï¼Œä¸‘å¹´åœ¨å¯…...
  const tianyaoPos = (yearBranchIndex + 1) % 12
  positions.set('å¤©å§š', [tianyaoPos])
  
  // å’¸æ±  - æ ¹æ®å¹´æ”¯ï¼ˆæ¡ƒèŠ±ä½ï¼‰
  // ç”³å­è¾°åœ¨é…‰ï¼Œå·³é…‰ä¸‘åœ¨åˆï¼Œå¯…åˆæˆŒåœ¨å¯ï¼Œäº¥å¯æœªåœ¨å­
  const xianchiTable: Record<number, number> = {
    0: 9,   // å­å¹´åœ¨é…‰
    1: 6,   // ä¸‘å¹´åœ¨åˆ
    2: 3,   // å¯…å¹´åœ¨å¯
    3: 0,   // å¯å¹´åœ¨å­
    4: 9,   // è¾°å¹´åœ¨é…‰
    5: 6,   // å·³å¹´åœ¨åˆ
    6: 3,   // åˆå¹´åœ¨å¯
    7: 0,   // æœªå¹´åœ¨å­
    8: 9,   // ç”³å¹´åœ¨é…‰
    9: 6,   // é…‰å¹´åœ¨åˆ
    10: 3,  // æˆŒå¹´åœ¨å¯
    11: 0   // äº¥å¹´åœ¨å­
  }
  
  const xianchiPos = xianchiTable[yearBranchIndex] || 0
  positions.set('å’¸æ± ', [xianchiPos])
  
  return positions
}

/**
 * è®¡ç®—å°æ˜Ÿä½ç½®
 * Calculate minor star positions
 * 
 * @ai-context å°æ˜Ÿä¸åŒ…å«å·²åˆ†ç±»çš„ç…æ˜Ÿã€æ¡ƒèŠ±æ˜Ÿç­‰
 * åŒ…å«åšå£«åäºŒç¥ã€å¹´å¹²ç³»ã€å¹´æ”¯ç³»ã€æœˆç³»ã€æ—¥ç³»ç­‰å¤šç»„å°æ˜Ÿ
 * 
 * @param month å†œå†æœˆ (1-12)
 * @param day å†œå†æ—¥ (1-30)
 * @param timeZhiIndex æ—¶è¾°ç´¢å¼• (0-11)
 * @param yearStem å¹´å¹²
 * @param yearBranch å¹´æ”¯
 * @param lifePalaceIndex å‘½å®«ç´¢å¼• (0-11)
 * @param bodyPalaceIndex èº«å®«ç´¢å¼• (0-11)
 */
export function calculateMinorStarPositions(
  month: number,
  day: number,
  timeZhiIndex: number,
  yearStem: string,
  yearBranch: string,
  lifePalaceIndex?: number,
  bodyPalaceIndex?: number
): Map<string, number[]> {
  const positions = new Map<string, number[]>()
  const yearBranchIndex = BRANCHES.indexOf(yearBranch as any)
  const yearStemIndex = STEMS.indexOf(yearStem as any)
  
  // === å·²æœ‰å°æ˜Ÿ ===
  
  // ä¸‰å° - åŸºäºå·¦è¾…ä½ç½®å’Œç”Ÿæ—¥è®¡ç®—
  const zuofuPosition = (4 + (month - 1)) % 12  // å·¦è¾…ä½ç½®
  const santaiPos = (zuofuPosition + (day - 1)) % 12  // ä»å·¦è¾…ä½ç½®æ•°æ—¥æœŸ
  positions.set('ä¸‰å°', [santaiPos])
  
  // å…«åº§ - åŸºäºå³å¼¼ä½ç½®å’Œç”Ÿæ—¥è®¡ç®—
  const youbiPosition = (10 - (month - 1) + 12) % 12  // å³å¼¼ä½ç½®
  const bazuoPos = (youbiPosition - (day - 1) + 12) % 12  // ä»å³å¼¼ä½ç½®é€†æ•°æ—¥æœŸ
  positions.set('å…«åº§', [bazuoPos])
  
  // æ©å…‰ - åŸºäºæ–‡æ˜Œä½ç½®ï¼ˆå¹´å¹²æŸ¥è¡¨ï¼‰å’Œç”Ÿæ—¥
  const wenchangByGanTable: Record<string, number> = {
    'ç”²': 5,   // å·³
    'ä¹™': 6,   // åˆ
    'ä¸™': 8,   // ç”³
    'ä¸': 9,   // é…‰
    'æˆŠ': 8,   // ç”³
    'å·±': 9,   // é…‰
    'åºš': 11,  // äº¥
    'è¾›': 0,   // å­
    'å£¬': 2,   // å¯…
    'ç™¸': 3    // å¯
  }
  const wenchangPosition = wenchangByGanTable[yearStem] ?? 0
  const enguangPos = (wenchangPosition + (day - 1)) % 12  // ä»æ–‡æ˜Œä½ç½®é¡ºæ•°ç”Ÿæ—¥æ•°
  positions.set('æ©å…‰', [enguangPos])
  
  // å¤©è´µ - åŸºäºæ–‡æ›²ä½ç½®å’Œç”Ÿæ—¥
  // ä»æ–‡æ›²çš„ä¸‹ä¸€ä¸ªå®«ä½å¼€å§‹ï¼Œé¡ºæ—¶é’ˆæ•°ç”Ÿæ—¥-1æ ¼
  const wenquPosition = (4 + timeZhiIndex) % 12  // æ–‡æ›²ä½ç½®
  const tianguiSteps = Math.max(0, day - 1)  // ç”Ÿæ—¥-1ï¼Œè‡³å°‘ä¸º0
  const tianguiPos = (wenquPosition + 1 + tianguiSteps) % 12  // ä»æ–‡æ›²ä¸‹ä¸€å®«å¼€å§‹
  positions.set('å¤©è´µ', [tianguiPos])
  
  // é¾™æ± å‡¤é˜ - æ ¹æ®å¹´æ”¯
  positions.set('é¾™æ± ', [(yearBranchIndex + 4) % 12])
  positions.set('å‡¤é˜', [(10 - yearBranchIndex + 12) % 12])
  
  // å­¤è¾°å¯¡å®¿ - æ ¹æ®å¹´æ”¯ï¼ˆå­¤å¯¡æ˜Ÿï¼‰
  const guchenTable = [2, 2, 5, 5, 5, 8, 8, 8, 11, 11, 11, 2]
  const guasuTable = [10, 10, 10, 1, 1, 1, 4, 4, 4, 7, 7, 7]
  positions.set('å­¤è¾°', [guchenTable[yearBranchIndex]])
  positions.set('å¯¡å®¿', [guasuTable[yearBranchIndex]])
  
  // å¤©å“­å¤©è™š - æ ¹æ®å¹´æ”¯
  positions.set('å¤©å“­', [(6 - yearBranchIndex + 12) % 12])
  positions.set('å¤©è™š', [(6 + yearBranchIndex) % 12])
  
  // å¤©å®˜ - æ ¹æ®å¹´å¹²
  const tianguanTable: Record<string, number> = {
    'ç”²': 7,   // æœª
    'ä¹™': 4,   // è¾°
    'ä¸™': 5,   // å·³
    'ä¸': 2,   // å¯…
    'æˆŠ': 3,   // å¯
    'å·±': 9,   // é…‰
    'åºš': 11,  // äº¥
    'è¾›': 9,   // é…‰
    'å£¬': 10,  // æˆŒ
    'ç™¸': 0    // å­
  }
  const tianguanPos = tianguanTable[yearStem] ?? 0
  positions.set('å¤©å®˜', [tianguanPos])
  
  // å¤©ç¦ - æ ¹æ®å¹´å¹²
  const tianfuTable: Record<string, number> = {
    'ç”²': 9,   // é…‰
    'ä¹™': 8,   // ç”³
    'ä¸™': 0,   // å­
    'ä¸': 11,  // äº¥
    'æˆŠ': 3,   // å¯
    'å·±': 2,   // å¯…
    'åºš': 6,   // åˆ
    'è¾›': 5,   // å·³
    'å£¬': 6,   // åˆ
    'ç™¸': 5    // å·³
  }
  const tianfuPos = tianfuTable[yearStem] ?? 0
  positions.set('å¤©ç¦', [tianfuPos])
  
  // å°è¾… - ä»åˆå®«èµ·å­æ—¶ï¼Œé¡ºæ—¶é’ˆæ•°è‡³ç”Ÿæ—¶
  const taifuPos = (6 + timeZhiIndex) % 12  // åˆå®«ç´¢å¼•6 + ç”Ÿæ—¶ç´¢å¼•
  positions.set('å°è¾…', [taifuPos])
  
  // å°è¯° - ä»å¯…å®«èµ·å­æ—¶ï¼Œé¡ºæ•°è‡³ç”Ÿæ—¶æ”¯
  const fenggaoPos = (2 + timeZhiIndex) % 12  // å¯…å®«ç´¢å¼•2ï¼ŒåŠ æ—¶è¾°ç´¢å¼•
  positions.set('å°è¯°', [fenggaoPos])
  
  // === æ–°å¢21é¢—å°æ˜Ÿ ===
  
  // 1. å¤©ç©º (åšå£«åäºŒç¥ç…ä¹‹ä¸€) - æ ¹æ®å¹´æ”¯
  // å­å¹´åœ¨ä¸‘ï¼Œä¸‘å¹´åœ¨å¯…ï¼Œä¾æ¬¡ç±»æ¨
  const tiankongPos = (yearBranchIndex + 1) % 12
  positions.set('å¤©ç©º', [tiankongPos])
  
  // 2. å¤©å¨ - æ ¹æ®ç”Ÿå¹´å¤©å¹²
  const tianchuTable: Record<string, number> = {
    'ç”²': 5,  // å·³
    'ä¹™': 6,  // åˆ
    'ä¸™': 0,  // å­
    'ä¸': 11, // äº¥
    'æˆŠ': 8,  // ç”³
    'å·±': 9,  // é…‰
    'åºš': 2,  // å¯…
    'è¾›': 3,  // å¯
    'å£¬': 6,  // åˆ
    'ç™¸': 5   // å·³
  }
  const tianchuPos = tianchuTable[yearStem] ?? 0
  positions.set('å¤©å¨', [tianchuPos])
  
  // 3. æˆªç©º (æ­£ç©ºä¸å‚ç©º) - æ ¹æ®ç”Ÿå¹´å¤©å¹²ï¼Œä¸¤ä¸ªä½ç½®
  const jiekongTable: Record<string, [number, number]> = {
    'ç”²': [8, 9],   // ç”³ã€é…‰
    'å·±': [8, 9],   // ç”³ã€é…‰
    'ä¹™': [6, 7],   // åˆã€æœª
    'åºš': [6, 7],   // åˆã€æœª
    'ä¸™': [4, 5],   // è¾°ã€å·³
    'è¾›': [4, 5],   // è¾°ã€å·³
    'ä¸': [2, 3],   // å¯…ã€å¯
    'å£¬': [2, 3],   // å¯…ã€å¯
    'æˆŠ': [0, 1],   // å­ã€ä¸‘
    'ç™¸': [0, 1]    // å­ã€ä¸‘
  }
  const [jiekong1, jiekong2] = jiekongTable[yearStem] ?? [0, 11]
  positions.set('æˆªç©º', [jiekong1, jiekong2])
  
  // 4. æ—¬ç©º - æ ¹æ®å¹´æŸ±å¹²æ”¯è®¡ç®—æ—¬ç©ºå’Œå‰¯æ—¬ç©ºï¼ˆæ­£ç¡®å…­åç”²å­ç®—æ³•ï¼‰
  // å…­æ—¬æ—¬ç©ºå¯¹ç…§è¡¨
  const xunkongTable: Record<string, [number, number]> = {
    // ç”²å­æ—¬ (ç”²å­è‡³ç™¸é…‰) - æ—¬ç©ºæˆŒäº¥
    'ç”²å­': [10, 11], 'ä¹™ä¸‘': [10, 11], 'ä¸™å¯…': [10, 11], 'ä¸å¯': [10, 11], 'æˆŠè¾°': [10, 11],
    'å·±å·³': [10, 11], 'åºšåˆ': [10, 11], 'è¾›æœª': [10, 11], 'å£¬ç”³': [10, 11], 'ç™¸é…‰': [10, 11],
    // ç”²æˆŒæ—¬ (ç”²æˆŒè‡³ç™¸æœª) - æ—¬ç©ºç”³é…‰
    'ç”²æˆŒ': [8, 9], 'ä¹™äº¥': [8, 9], 'ä¸™å­': [8, 9], 'ä¸ä¸‘': [8, 9], 'æˆŠå¯…': [8, 9],
    'å·±å¯': [8, 9], 'åºšè¾°': [8, 9], 'è¾›å·³': [8, 9], 'å£¬åˆ': [8, 9], 'ç™¸æœª': [8, 9],
    // ç”²ç”³æ—¬ (ç”²ç”³è‡³ç™¸å·³) - æ—¬ç©ºåˆæœª
    'ç”²ç”³': [6, 7], 'ä¹™é…‰': [6, 7], 'ä¸™æˆŒ': [6, 7], 'ä¸äº¥': [6, 7], 'æˆŠå­': [6, 7],
    'å·±ä¸‘': [6, 7], 'åºšå¯…': [6, 7], 'è¾›å¯': [6, 7], 'å£¬è¾°': [6, 7], 'ç™¸å·³': [6, 7],
    // ç”²åˆæ—¬ (ç”²åˆè‡³ç™¸å¯) - æ—¬ç©ºè¾°å·³
    'ç”²åˆ': [4, 5], 'ä¹™æœª': [4, 5], 'ä¸™ç”³': [4, 5], 'ä¸é…‰': [4, 5], 'æˆŠæˆŒ': [4, 5],
    'å·±äº¥': [4, 5], 'åºšå­': [4, 5], 'è¾›ä¸‘': [4, 5], 'å£¬å¯…': [4, 5], 'ç™¸å¯': [4, 5],
    // ç”²è¾°æ—¬ (ç”²è¾°è‡³ç™¸ä¸‘) - æ—¬ç©ºå¯…å¯
    'ç”²è¾°': [2, 3], 'ä¹™å·³': [2, 3], 'ä¸™åˆ': [2, 3], 'ä¸æœª': [2, 3], 'æˆŠç”³': [2, 3],
    'å·±é…‰': [2, 3], 'åºšæˆŒ': [2, 3], 'è¾›äº¥': [2, 3], 'å£¬å­': [2, 3], 'ç™¸ä¸‘': [2, 3],
    // ç”²å¯…æ—¬ (ç”²å¯…è‡³ç™¸äº¥) - æ—¬ç©ºå­ä¸‘
    'ç”²å¯…': [0, 1], 'ä¹™å¯': [0, 1], 'ä¸™è¾°': [0, 1], 'ä¸å·³': [0, 1], 'æˆŠåˆ': [0, 1],
    'å·±æœª': [0, 1], 'åºšç”³': [0, 1], 'è¾›é…‰': [0, 1], 'å£¬æˆŒ': [0, 1], 'ç™¸äº¥': [0, 1]
  }
  
  const yearGanZhi = yearStem + yearBranch
  const [kong1, kong2] = xunkongTable[yearGanZhi] ?? [10, 11]
  
  // åˆ¤æ–­å¹´å¹²é˜´é˜³å±æ€§ç¡®å®šæ­£ç©ºå’Œå‰¯ç©º
  const yangStem = ['ç”²', 'ä¸™', 'æˆŠ', 'åºš', 'å£¬'].includes(yearStem)
  const yangBranches = [0, 2, 4, 6, 8, 10]  // å­å¯…è¾°åˆç”³æˆŒä¸ºé˜³æ”¯
  
  let zhengkong, fukong
  if ((yangBranches.includes(kong1) && yangStem) || (!yangBranches.includes(kong1) && !yangStem)) {
    zhengkong = kong1
    fukong = kong2
  } else {
    zhengkong = kong2
    fukong = kong1
  }
  
  positions.set('æ—¬ç©º', [zhengkong, fukong])
  
  // 5. å¤©å·« - æ ¹æ®å¹´æ”¯å’Œæœˆä»½è®¡ç®—
  // è§„åˆ™ï¼šå››é©¬ä¹‹åœ°èµ·æ­£æœˆï¼Œé¡ºæ•°è‡³ç”Ÿæœˆ
  // å¯…å¯è¾°å¹´ä»å·³å®«èµ·ï¼Œå·³åˆæœªå¹´ä»ç”³å®«èµ·ï¼Œç”³é…‰æˆŒå¹´ä»äº¥å®«èµ·ï¼Œäº¥å­ä¸‘å¹´ä»å¯…å®«èµ·
  let tianwuStartPos: number
  if ([2, 3, 4].includes(yearBranchIndex)) {  // å¯…å¯è¾°å¹´ï¼ˆæ˜¥å­£ï¼‰
    tianwuStartPos = 5  // ä»å·³å®«èµ·
  } else if ([5, 6, 7].includes(yearBranchIndex)) {  // å·³åˆæœªå¹´ï¼ˆå¤å­£ï¼‰
    tianwuStartPos = 8  // ä»ç”³å®«èµ·
  } else if ([8, 9, 10].includes(yearBranchIndex)) {  // ç”³é…‰æˆŒå¹´ï¼ˆç§‹å­£ï¼‰
    tianwuStartPos = 11  // ä»äº¥å®«èµ·
  } else {  // äº¥å­ä¸‘å¹´ï¼ˆå†¬å­£ï¼‰
    tianwuStartPos = 2  // ä»å¯…å®«èµ·
  }
  const tianwuPos = (tianwuStartPos + (month - 1)) % 12  // ä»èµ·å§‹å®«é¡ºæ•°åˆ°ç”Ÿæœˆ
  positions.set('å¤©å·«', [tianwuPos])
  
  // 6. è§£ç¥ - ä»ç”³å®«èµ·æ­£æœˆï¼Œé¡ºæ—¶é’ˆæ•°è‡³ç”Ÿæœˆ
  const jieshenPos = (8 + (month - 1)) % 12  // ç”³å®«ç´¢å¼•8
  positions.set('è§£ç¥', [jieshenPos])
  
  // 7. ç ´ç¢ - æ ¹æ®å¹´æ”¯
  const posuiTable: Record<number, number> = {
    0: 5,   // å­(å­åˆå¯é…‰)åœ¨å·³
    1: 1,   // ä¸‘(è¾°æˆŒä¸‘æœª)åœ¨ä¸‘
    2: 9,   // å¯…(å¯…ç”³å·³äº¥)åœ¨é…‰
    3: 5,   // å¯(å­åˆå¯é…‰)åœ¨å·³
    4: 1,   // è¾°(è¾°æˆŒä¸‘æœª)åœ¨ä¸‘
    5: 9,   // å·³(å¯…ç”³å·³äº¥)åœ¨é…‰
    6: 5,   // åˆ(å­åˆå¯é…‰)åœ¨å·³
    7: 1,   // æœª(è¾°æˆŒä¸‘æœª)åœ¨ä¸‘
    8: 9,   // ç”³(å¯…ç”³å·³äº¥)åœ¨é…‰
    9: 5,   // é…‰(å­åˆå¯é…‰)åœ¨å·³
    10: 1,  // æˆŒ(è¾°æˆŒä¸‘æœª)åœ¨ä¸‘
    11: 9   // äº¥(å¯…ç”³å·³äº¥)åœ¨é…‰
  }
  const posuiPos = posuiTable[yearBranchIndex] ?? 0
  positions.set('ç ´ç¢', [posuiPos])
  
  // 8. åç›– - æ ¹æ®å¹´æ”¯ï¼ˆå¯…åˆæˆŒåœ¨æˆŒï¼Œäº¥å¯æœªåœ¨æœªï¼Œç”³å­è¾°åœ¨è¾°ï¼Œå·³é…‰ä¸‘åœ¨ä¸‘ï¼‰
  const huagaiTable: Record<number, number> = {
    0: 4,   // å­(ç”³å­è¾°)åœ¨è¾°
    1: 1,   // ä¸‘(å·³é…‰ä¸‘)åœ¨ä¸‘
    2: 10,  // å¯…(å¯…åˆæˆŒ)åœ¨æˆŒ
    3: 7,   // å¯(äº¥å¯æœª)åœ¨æœª
    4: 4,   // è¾°(ç”³å­è¾°)åœ¨è¾°
    5: 1,   // å·³(å·³é…‰ä¸‘)åœ¨ä¸‘
    6: 10,  // åˆ(å¯…åˆæˆŒ)åœ¨æˆŒ
    7: 7,   // æœª(äº¥å¯æœª)åœ¨æœª
    8: 4,   // ç”³(ç”³å­è¾°)åœ¨è¾°
    9: 1,   // é…‰(å·³é…‰ä¸‘)åœ¨ä¸‘
    10: 10, // æˆŒ(å¯…åˆæˆŒ)åœ¨æˆŒ
    11: 7   // äº¥(äº¥å¯æœª)åœ¨æœª
  }
  const huagaiPos = huagaiTable[yearBranchIndex] ?? 0
  positions.set('åç›–', [huagaiPos])
  
  // 9. å¤©å¾· - ä»é…‰å®«èµ·å­å¹´ï¼Œé¡ºæ—¶é’ˆæ•°è‡³ç”Ÿå¹´åœ°æ”¯
  const tiandePos = (9 + yearBranchIndex) % 12
  positions.set('å¤©å¾·', [tiandePos])
  
  // 10. å¤©æ‰ - ä»å‘½å®«èµ·å­å¹´ï¼Œé¡ºæ—¶é’ˆæ•°è‡³ç”Ÿå¹´åœ°æ”¯
  if (lifePalaceIndex !== undefined) {
    const tiancaiPos = (lifePalaceIndex + yearBranchIndex) % 12
    positions.set('å¤©æ‰', [tiancaiPos])
  }
  
  // 11. å¤©å¯¿ - ä»èº«å®«èµ·å­å¹´ï¼Œé¡ºæ—¶é’ˆæ•°è‡³ç”Ÿå¹´åœ°æ”¯
  if (bodyPalaceIndex !== undefined) {
    const tianshouPos = (bodyPalaceIndex + yearBranchIndex) % 12
    positions.set('å¤©å¯¿', [tianshouPos])
  }
  
  // 12. å¤©ä½¿ - å›ºå®šåœ¨ç–¾å„å®«
  // ç–¾å„å®«æ˜¯å‘½å®«é€†æ—¶é’ˆç¬¬6å®«
  if (lifePalaceIndex !== undefined) {
    const jiegongIndex = (lifePalaceIndex - 5 + 12) % 12  // ç–¾å„å®«ä½ç½®
    positions.set('å¤©ä½¿', [jiegongIndex])
  }
  
  // 13. å¤©ä¼¤ - å›ºå®šåœ¨ä»†å½¹å®«ï¼ˆäº¤å‹å®«ï¼‰
  // äº¤å‹å®«æ˜¯å‘½å®«é€†æ—¶é’ˆç¬¬8å®«
  if (lifePalaceIndex !== undefined) {
    const jiaoyouGongIndex = (lifePalaceIndex - 7 + 12) % 12
    positions.set('å¤©ä¼¤', [jiaoyouGongIndex])
  }
  
  // 14. åŠ«ç… - æ ¹æ®å¹´æ”¯ï¼ˆå¯…åˆæˆŒåœ¨äº¥ï¼Œäº¥å¯æœªåœ¨ç”³ï¼Œç”³å­è¾°åœ¨å·³ï¼Œå·³é…‰ä¸‘åœ¨å¯…ï¼‰
  const jieshaTable: Record<number, number> = {
    0: 5,   // å­(ç”³å­è¾°)åœ¨å·³
    1: 2,   // ä¸‘(å·³é…‰ä¸‘)åœ¨å¯…
    2: 11,  // å¯…(å¯…åˆæˆŒ)åœ¨äº¥
    3: 8,   // å¯(äº¥å¯æœª)åœ¨ç”³
    4: 5,   // è¾°(ç”³å­è¾°)åœ¨å·³
    5: 2,   // å·³(å·³é…‰ä¸‘)åœ¨å¯…
    6: 11,  // åˆ(å¯…åˆæˆŒ)åœ¨äº¥
    7: 8,   // æœª(äº¥å¯æœª)åœ¨ç”³
    8: 5,   // ç”³(ç”³å­è¾°)åœ¨å·³
    9: 2,   // é…‰(å·³é…‰ä¸‘)åœ¨å¯…
    10: 11, // æˆŒ(å¯…åˆæˆŒ)åœ¨äº¥
    11: 8   // äº¥(äº¥å¯æœª)åœ¨ç”³
  }
  const jieshaPos = jieshaTable[yearBranchIndex] ?? 0
  positions.set('åŠ«ç…', [jieshaPos])
  
  // 16. æ¯ç¥ - åŸºäºå°†æ˜Ÿä½ç½®é¡ºæ—¶é’ˆæ•°ç¬¬4ä¸ªå®«ä½
  // å…ˆç¡®å®šå°†æ˜Ÿä½ç½®ï¼ˆæ ¹æ®å¹´æ”¯ä¸‰åˆå±€ï¼‰
  let jiangxingPos: number
  if ([8, 0, 4].includes(yearBranchIndex)) {  // ç”³å­è¾°æ°´å±€
    jiangxingPos = 0  // å°†æ˜Ÿåœ¨å­
  } else if ([2, 6, 10].includes(yearBranchIndex)) {  // å¯…åˆæˆŒç«å±€
    jiangxingPos = 6  // å°†æ˜Ÿåœ¨åˆ
  } else if ([11, 3, 7].includes(yearBranchIndex)) {  // äº¥å¯æœªæœ¨å±€
    jiangxingPos = 3  // å°†æ˜Ÿåœ¨å¯
  } else {  // å·³é…‰ä¸‘é‡‘å±€
    jiangxingPos = 9  // å°†æ˜Ÿåœ¨é…‰
  }
  // æ¯ç¥åœ¨å°†æ˜Ÿé¡ºæ—¶é’ˆç¬¬4ä¸ªå®«ä½ï¼ˆå°†æ˜Ÿ->æ”€é->å²é©¿->æ¯ç¥ï¼‰
  const xishenPos = (jiangxingPos + 3) % 12
  positions.set('æ¯ç¥', [xishenPos])
  
  // 17. å¤©ç… - æ ¹æ®å¹´æ”¯ï¼ˆå¯…åˆæˆŒåœ¨ä¸‘ï¼Œäº¥å¯æœªåœ¨æˆŒï¼Œç”³å­è¾°åœ¨æœªï¼Œå·³é…‰ä¸‘åœ¨è¾°ï¼‰
  const tianshaTable: Record<number, number> = {
    0: 7,   // å­(ç”³å­è¾°)åœ¨æœª
    1: 4,   // ä¸‘(å·³é…‰ä¸‘)åœ¨è¾°
    2: 1,   // å¯…(å¯…åˆæˆŒ)åœ¨ä¸‘
    3: 10,  // å¯(äº¥å¯æœª)åœ¨æˆŒ
    4: 7,   // è¾°(ç”³å­è¾°)åœ¨æœª
    5: 4,   // å·³(å·³é…‰ä¸‘)åœ¨è¾°
    6: 1,   // åˆ(å¯…åˆæˆŒ)åœ¨ä¸‘
    7: 10,  // æœª(äº¥å¯æœª)åœ¨æˆŒ
    8: 7,   // ç”³(ç”³å­è¾°)åœ¨æœª
    9: 4,   // é…‰(å·³é…‰ä¸‘)åœ¨è¾°
    10: 1,  // æˆŒ(å¯…åˆæˆŒ)åœ¨ä¸‘
    11: 10  // äº¥(äº¥å¯æœª)åœ¨æˆŒ
  }
  const tianshaPos = tianshaTable[yearBranchIndex] ?? 0
  positions.set('å¤©ç…', [tianshaPos])
  
  // 18. å¤©æœˆ - æ ¹æ®å¹´æ”¯æŸ¥è¡¨
  const tianyueTable: Record<number, number> = {
    0: 7,   // å­å¹´åœ¨æœª
    1: 2,   // ä¸‘å¹´åœ¨å¯…
    2: 10,  // å¯…å¹´åœ¨æˆŒ
    3: 5,   // å¯å¹´åœ¨å·³
    4: 4,   // è¾°å¹´åœ¨è¾°
    5: 11,  // å·³å¹´åœ¨äº¥
    6: 8,   // åˆå¹´åœ¨ç”³
    7: 3,   // æœªå¹´åœ¨å¯
    8: 6,   // ç”³å¹´åœ¨åˆ
    9: 1,   // é…‰å¹´åœ¨ä¸‘
    10: 9,  // æˆŒå¹´åœ¨é…‰
    11: 0   // äº¥å¹´åœ¨å­
  }
  const tianyuePos = tianyueTable[yearBranchIndex] ?? 0
  positions.set('å¤©æœˆ', [tianyuePos])
  
  // 19. é˜´ç… - æ ¹æ®ç”Ÿæœˆå›ºå®šå¯¹åº”å…³ç³»
  const yinshaTable: Record<number, number> = {
    1: 2,   // æ­£æœˆåœ¨å¯…
    2: 0,   // äºŒæœˆåœ¨å­
    3: 10,  // ä¸‰æœˆåœ¨æˆŒ
    4: 8,   // å››æœˆåœ¨ç”³
    5: 6,   // äº”æœˆåœ¨åˆ
    6: 4,   // å…­æœˆåœ¨è¾°
    7: 2,   // ä¸ƒæœˆåœ¨å¯…
    8: 0,   // å…«æœˆåœ¨å­
    9: 10,  // ä¹æœˆåœ¨æˆŒ
    10: 8,  // åæœˆåœ¨ç”³
    11: 6,  // åä¸€æœˆåœ¨åˆ
    12: 4   // åäºŒæœˆåœ¨è¾°
  }
  const yinshaPos = yinshaTable[month] ?? 0
  positions.set('é˜´ç…', [yinshaPos])
  
  // 20. æœˆå¾· - ä»å·³å®«èµ·æ­£æœˆï¼Œé¡ºæ—¶é’ˆæ•°è‡³ç”Ÿæœˆ
  const yuedePos = (5 + (month - 1)) % 12
  positions.set('æœˆå¾·', [yuedePos])
  
  
  return positions
}

/**
 * è®¡ç®—ç”Ÿå¹´å››åŒ–
 * Calculate birth year Si Hua transformations
 */
export function calculateBirthYearSihua(yearStem: string): {
  A: string // ç¦„
  B: string // æƒ
  C: string // ç§‘
  D: string // å¿Œ
} {
  return BIRTH_YEAR_SIHUA[yearStem] || { A: '', B: '', C: '', D: '' }
}

/**
 * è®¡ç®—é£å®«å››åŒ–
 * Calculate flying palace Si Hua transformations
 */
export function calculateFlyingPalaceSihua(
  palaceStem: string,
  targetPalaceIndex: number,
  sourcePalaceIndex: number
): Array<{ star: string; type: string }> {
  const sihua = FLYING_PALACE_SIHUA[palaceStem]
  if (!sihua) return []
  
  const transformations: Array<{ star: string; type: string }> = []
  
  // åˆ¤æ–­æ˜¯å‘å¿ƒè¿˜æ˜¯ç¦»å¿ƒ
  const isInward = targetPalaceIndex === (sourcePalaceIndex + 6) % 12 // å¯¹å®«
  const prefix = isInward ? 'i' : 'x'
  
  // æ·»åŠ å››åŒ–
  if (sihua.A) transformations.push({ star: sihua.A, type: `${prefix}A` })
  if (sihua.B) transformations.push({ star: sihua.B, type: `${prefix}B` })
  if (sihua.C) transformations.push({ star: sihua.C, type: `${prefix}C` })
  if (sihua.D) transformations.push({ star: sihua.D, type: `${prefix}D` })
  
  return transformations
}

/**
 * è®¡ç®—æ–—å›ä½ç½® (å…ˆå¤©æ–—å›)
 * Calculate DouJun (Star General) position
 * æ–—å›ç®—æ³•ï¼šä»¥å­å®«èµ·æ­£æœˆï¼Œé€†æ•°ç”Ÿæœˆï¼Œæ‰€è½ä¹‹å®«å†èµ·å­æ—¶ï¼Œé¡ºæ•°ç”Ÿæ—¶
 * 
 * @param monthLunar å†œå†æœˆä»½ (1-12)
 * @param timeZhiIndex ç”Ÿæ—¶åœ°æ”¯ç´¢å¼• (0-11, å¯¹åº”å­ä¸‘å¯…...)
 * @returns æ–—å›æ‰€åœ¨åœ°æ”¯
 */
export function calculateDouJun(monthLunar: number, timeZhiIndex: number): string {
  // å­å®«èµ·æ­£æœˆï¼Œé€†æ•°ç”Ÿæœˆ
  // å­å®«ç´¢å¼•0ï¼Œæ­£æœˆ(1) -> å­(0), äºŒæœˆ(2) -> äº¥(11), ä¸‰æœˆ(3) -> æˆŒ(10), ...
  // é€†æ•°å…¬å¼ï¼š(12 - (monthLunar - 1)) % 12 = (13 - monthLunar) % 12
  const monthPosition = (13 - monthLunar) % 12
  
  // ä»è¯¥å®«èµ·å­æ—¶ï¼Œé¡ºæ•°ç”Ÿæ—¶
  // å­æ—¶(0)åœ¨æœˆå®«ï¼Œä¸‘æ—¶(1)åœ¨ä¸‹ä¸€å®«ï¼Œä»¥æ­¤ç±»æ¨
  const douJunPosition = (monthPosition + timeZhiIndex) % 12
  
  return BRANCHES[douJunPosition]
}

/**
 * è®¡ç®—å‘½ä¸»èº«ä¸»
 * Calculate life and body masters
 * 
 * @param yearBranch å¹´æ”¯
 * @returns å‘½ä¸»å’Œèº«ä¸»æ˜Ÿ
 */
export function calculateMasters(yearBranch: string, lifePalaceBranch: string): {
  lifeMaster: string
  bodyMaster: string
} {
  const yearBranchIndex = BRANCHES.indexOf(yearBranch as any)
  const lifePalaceBranchIndex = BRANCHES.indexOf(lifePalaceBranch as any)
  return {
    lifeMaster: LIFE_MASTER_STARS[lifePalaceBranchIndex], // å‘½ä¸»ç”¨å‘½å®«åœ°æ”¯ç´¢å¼•
    bodyMaster: BODY_MASTER_STARS[yearBranchIndex]        // èº«ä¸»ç”¨å‡ºç”Ÿå¹´æ”¯ç´¢å¼•
  }
}

/**
 * è·å–å…ˆå¤©æ–—å›å®«ä½ç´¢å¼•
 * Get Innate Dou Jun palace index
 * 
 * @description
 * å…ˆå¤©æ–—å›æ˜¯ç´«å¾®æ–—æ•°ä¸­ç”¨äºç¡®å®šæµå¹´å®«ä½çš„é‡è¦æ¦‚å¿µ
 * ä»æ­£æœˆèµ·å­å®«ï¼Œé€†æ•°åˆ°å‡ºç”Ÿæœˆä»½ï¼Œå†ä»è¯¥å®«èµ·å­æ—¶ï¼Œé¡ºæ•°åˆ°å‡ºç”Ÿæ—¶è¾°
 * 
 * @param month å†œå†ç”Ÿæœˆ (1-12)
 * @param timeZhiIndex ç”Ÿæ—¶åœ°æ”¯ç´¢å¼• (0-11)
 * @returns å®«ä½ç´¢å¼• (0-11ï¼Œå¯¹åº”å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥)
 */
export function getInnateDauPalaceIndex(month: number, timeZhiIndex: number): number {
  // æ­£æœˆåœ¨å­å®«ï¼ˆç´¢å¼•0ï¼‰ï¼ŒäºŒæœˆåœ¨äº¥å®«ï¼ˆç´¢å¼•11ï¼‰ï¼Œä¸‰æœˆåœ¨æˆŒå®«ï¼ˆç´¢å¼•10ï¼‰...
  // å…¬å¼ï¼š(12 - (month - 1)) % 12 = (13 - month) % 12
  const monthPalaceIndex = (13 - month) % 12
  
  // ä»æœˆå®«èµ·å­æ—¶ï¼Œé¡ºæ•°åˆ°å‡ºç”Ÿæ—¶è¾°
  return (monthPalaceIndex + timeZhiIndex) % 12
}

/**
 * è®¡ç®—ç´«å¾®å¤§è¿èµ·è¿å²æ•°
 * Calculate ZiWei major period start age
 * 
 * ç´«å¾®å¤§è¿èµ·å§‹å¹´é¾„å°±æ˜¯äº”è¡Œå±€çš„å±€æ•°
 * å¦‚ï¼šæ°´äºŒå±€=2å²èµ·è¿ï¼Œç«å…­å±€=6å²èµ·è¿
 */
export function calculateMajorPeriodStartAge(
  bureau: string,
  yearStem: string,
  gender: 'male' | 'female'
): number {
  // ä»äº”è¡Œå±€ä»£ç æå–å±€æ•° (å¦‚ï¼š"fire_6" -> 6, "water_2" -> 2)
  const match = bureau.match(/_(\d+)$/)
  const bureauNumber = match ? parseInt(match[1]) : 6
  
  // ç´«å¾®å¤§è¿èµ·å§‹å¹´é¾„å°±æ˜¯å±€æ•°
  return bureauNumber
}

/**
 * è®¡ç®—ç´«å¾®å¤§è¿ä¿¡æ¯
 * Calculate ZiWei major period information
 * 
 * ç´«å¾®å¤§è¿è®¡ç®—è§„åˆ™ï¼š
 * 1. ç¬¬ä¸€ä¸ªå¤§è¿ä»å‘½å®«å¼€å§‹ï¼Œèµ·å§‹å¹´é¾„æ˜¯å±€æ•°ï¼Œç»“æŸå¹´é¾„æ˜¯å±€æ•°+9
 * 2. æ ¹æ®å¹´å¹²æ€§åˆ«åˆ¤æ–­é¡ºé€†
 * 3. é¡ºè¡Œï¼šå‘½å®«â†’çˆ¶æ¯å®«â†’ç¦å¾·å®«â†’ç”°å®…å®«...
 * 4. é€†è¡Œï¼šå‘½å®«â†’å…„å¼Ÿå®«â†’å¤«å¦»å®«â†’å­å¥³å®«...
 */
export function calculateMajorPeriods(
  startAge: number,
  birthYear: number,
  lifePalaceIndex: number,
  isClockwise: boolean
): Array<{
  period: number
  startAge: number
  endAge: number
  startYear: number
  endYear: number
  palaceIndex: number
}> {
  const periods = []
  
  // ç”Ÿæˆ12ä¸ªå¤§è¿ï¼Œæ¯ä¸ªå¤§è¿10å¹´
  for (let i = 0; i < 12; i++) {
    // ç¬¬ä¸€ä¸ªå¤§è¿èµ·å§‹å¹´é¾„æ˜¯å±€æ•°ï¼Œåç»­æ¯ä¸ªå¤§è¿+10å¹´
    const periodStartAge = startAge + i * 10
    const periodEndAge = periodStartAge + 9
    
    // è®¡ç®—å¤§è¿å®«ä½
    let palaceIndex
    if (isClockwise) {
      // é¡ºè¡Œï¼šå‘½å®« â†’ çˆ¶æ¯å®«(+1) â†’ ç¦å¾·å®«(+2) â†’ ...
      palaceIndex = (lifePalaceIndex + i) % 12
    } else {
      // é€†è¡Œï¼šå‘½å®« â†’ å…„å¼Ÿå®«(-1) â†’ å¤«å¦»å®«(-2) â†’ ...
      palaceIndex = (lifePalaceIndex - i + 12) % 12
    }
    
    periods.push({
      period: i + 1,
      startAge: periodStartAge,
      endAge: periodEndAge,
      startYear: birthYear + periodStartAge - 1,
      endYear: birthYear + periodEndAge - 1,
      palaceIndex
    })
  }
  
  return periods
}

/**
 * è®¡ç®—æµå¹´å²æ•°
 * Calculate fleeting year ages for a branch
 */
export function calculateFleetingYears(branchIndex: number): number[] {
  const years = []
  // ä»è¯¥åœ°æ”¯å¼€å§‹ï¼Œæ¯12å¹´å¾ªç¯ä¸€æ¬¡
  for (let i = 0; i < 10; i++) {
    years.push(branchIndex + 1 + i * 12)
  }
  return years
}

/**
 * è®¡ç®—æ¥å› å®«
 * Calculate Laiyin Palace (æ ¹æ®å¹´å¹²ç¡®å®šï¼Œä½¿ç”¨äº”è™éæ–¹æ³•å®šä½åœ°æ”¯)
 * äº”è™éï¼šç”²å·±å¹´èµ·ä¸™å¯…ï¼Œä¹™åºšå¹´èµ·æˆŠå¯…ï¼Œä¸™è¾›å¹´èµ·åºšå¯…ï¼Œä¸å£¬å¹´èµ·å£¬å¯…ï¼ŒæˆŠç™¸å¹´èµ·ç”²å¯…
 */
/**
 * è®¡ç®—æ¥å› å®«
 * Calculate Laiyin Palace
 * 
 * @description
 * æ¥å› å®«æ˜¯åäºŒå®«ä¸­å®«å¹²ä¸ç”Ÿå¹´å¤©å¹²ç›¸åŒçš„å®«ä½åç§°ã€‚
 * The Laiyin Palace is the palace name whose stem matches the year stem.
 * 
 * @algorithm
 * ä½¿ç”¨äº”è™éæ³•ç¡®å®šå„å®«å¤©å¹²ï¼Œæ‰¾å‡ºä¸å¹´å¹²ç›¸åŒçš„å®«ä½ï¼Œè¿”å›å…¶åœ¨å‘½ç›˜ä¸­çš„åç§°ã€‚
 * Uses Wu Hu Dun method to determine palace stems, finds the one matching year stem, returns palace name.
 * 
 * @param yearStem ç”Ÿå¹´å¤©å¹²
 * @param lifePalaceIndex å‘½å®«ä½ç½® (0-11)
 * @returns æ¥å› å®«åç§° (å‘½å®«/å…„å¼Ÿ/å¤«å¦»ç­‰)
 * 
 * @example
 * // ç”²å¹´ç”Ÿäººï¼Œå‘½å®«åœ¨å¯…
 * calculateLaiyinPalace('ç”²', 2) // è¿”å› "å¤«å¦»" (ç”²å¹´äº”è™éï¼Œç”³å®«å¤©å¹²ä¸ºç”²)
 */
export function calculateLaiyinPalace(yearStem: string, lifePalaceIndex: number): string {
  // äº”è™éè¡¨ï¼šå¹´å¹² -> å¯…å®«èµ·å§‹å¤©å¹²
  const wuHuDunTable: Record<string, string> = {
    'ç”²': 'ä¸™', 'å·±': 'ä¸™',  // ç”²å·±ä¹‹å¹´ä¸™ä½œé¦–
    'ä¹™': 'æˆŠ', 'åºš': 'æˆŠ',  // ä¹™åºšä¹‹å²æˆŠä¸ºå¤´  
    'ä¸™': 'åºš', 'è¾›': 'åºš',  // ä¸™è¾›å¿…å®šä»åºšèµ·
    'ä¸': 'å£¬', 'å£¬': 'å£¬',  // ä¸å£¬å£¬ä½é¡ºæµè¡Œ
    'æˆŠ': 'ç”²', 'ç™¸': 'ç”²'   // æˆŠç™¸ä¹‹å¹´ç”²å¯…å®«
  }
  
  const startStem = wuHuDunTable[yearStem]
  if (!startStem) return PALACE_NAMES[0] // é»˜è®¤è¿”å›å‘½å®«
  
  // ä»å¯…å®«(index=2)å¼€å§‹ï¼ŒæŒ‰äº”è™éæ¨ç®—å„å®«å¤©å¹²
  const startStemIndex = STEMS.indexOf(startStem as any)
  
  // éå†12å®«ï¼Œæ‰¾åˆ°å¤©å¹²ä¸å¹´å¹²ç›¸åŒçš„å®«ä½
  for (let i = 0; i < 12; i++) {
    // ä»å¯…å®«å¼€å§‹ï¼Œé¡ºæ—¶é’ˆè®¡ç®—å„å®«çš„å¤©å¹²
    // å¯…å®«=2, å¯å®«=3, ..., å­å®«=0, ä¸‘å®«=1
    const palaceIndex = (i + 2) % 12
    const palaceStemIndex = (startStemIndex + i) % 10
    const palaceStem = STEMS[palaceStemIndex]
    
    // æ‰¾åˆ°ä¸å¹´å¹²ç›¸åŒçš„å®«ä½
    if (palaceStem === yearStem) {
      // è®¡ç®—è¯¥å®«ä½ç›¸å¯¹äºå‘½å®«çš„ä½ç½®ï¼Œè¿”å›å¯¹åº”çš„å®«å
      const relativeIndex = (palaceIndex - lifePalaceIndex + 12) % 12
      return PALACE_NAMES[relativeIndex]
    }
  }
  
  return PALACE_NAMES[0] // é»˜è®¤è¿”å›å‘½å®«
}

/**
 * è®¡ç®—å°é™å®«ä½ç´¢å¼•
 * Calculate minor limit palace index for specific age
 * 
 * @param age å¹´é¾„ (è™šå²)
 * @param lifePalaceIndex å‘½å®«ç´¢å¼• (0-11)
 * @param yearBranch å‡ºç”Ÿå¹´æ”¯
 * @param gender æ€§åˆ«
 * @returns å°é™å®«ä½ç´¢å¼• (0-11)
 */
export function calculateMinorLimitPalace(
  age: number,
  lifePalaceIndex: number,
  yearBranch: string,
  gender: 'male' | 'female'
): number {
  // ç¡®å®šèµ·è¿å®«ä½ç½®ï¼ˆæ ¹æ®ç”Ÿå¹´åœ°æ”¯ä¸‰åˆå±€åœŸä½çš„ç›¸å†²ä½ï¼‰
  let startPalaceIndex: number
  
  switch (yearBranch) {
    case 'å¯…': case 'åˆ': case 'æˆŒ':
      // å¯…åˆæˆŒå¹´æ”¯åœ¨è¾°ä½èµ·è¿
      startPalaceIndex = 4  // è¾°å®«ç´¢å¼•
      break
    case 'ç”³': case 'å­': case 'è¾°':
      // ç”³å­è¾°å¹´æ”¯åœ¨æˆŒä½èµ·è¿  
      startPalaceIndex = 10 // æˆŒå®«ç´¢å¼•
      break
    case 'å·³': case 'é…‰': case 'ä¸‘':
      // å·³é…‰ä¸‘å¹´æ”¯åœ¨æœªä½èµ·è¿
      startPalaceIndex = 7  // æœªå®«ç´¢å¼•
      break
    case 'äº¥': case 'å¯': case 'æœª':
      // äº¥å¯æœªå¹´æ”¯åœ¨ä¸‘ä½èµ·è¿
      startPalaceIndex = 1  // ä¸‘å®«ç´¢å¼•
      break
    default:
      startPalaceIndex = 0  // é»˜è®¤å­å®«
  }
  
  // è®¡ç®—å°é™ä½ç½®
  // 1å²åœ¨èµ·è¿å®«ï¼Œ2å²åœ¨ä¸‹ä¸€å®«ï¼Œä¾æ­¤ç±»æ¨
  const offset = (age - 1) % 12
  
  if (gender === 'male') {
    // ç”·å‘½ä¸€å¾‹é¡ºè¡Œ
    return (startPalaceIndex + offset) % 12
  } else {
    // å¥³å‘½ä¸€å¾‹é€†è¡Œ
    return (startPalaceIndex - offset + 12) % 12
  }
}

/**
 * è®¡ç®—120å¹´å®Œæ•´å°é™åˆ†å¸ƒ
 * Calculate complete 120-year minor limits distribution from birth year position
 * @param yearBranch å‡ºç”Ÿå¹´æ”¯
 * @param gender æ€§åˆ«
 * @param lifePalaceIndex å‘½å®«ç´¢å¼•ï¼ˆå¯é€‰ï¼Œç”¨äºå…¼å®¹æ€§ï¼‰
 * @returns å„åœ°æ”¯ä½ç½®å¯¹åº”çš„å¹´é¾„æ•°ç»„
 */
export function calculate120YearMinorLimits(
  yearBranch: string,
  gender: 'male' | 'female',
  lifePalaceIndex?: number
): Record<number, number[]> {
  const result: Record<number, number[]> = {}
  
  // åˆå§‹åŒ–å„åœ°æ”¯ä½ç½®çš„å¹´é¾„æ•°ç»„
  for (let i = 0; i < 12; i++) {
    result[i] = []
  }
  
  // ç¡®å®šèµ·è¿å®«ä½ç½®ï¼ˆæ ¹æ®ç”Ÿå¹´åœ°æ”¯ä¸‰åˆå±€åœŸä½çš„ç›¸å†²ä½ï¼‰
  let startPalaceIndex: number
  
  switch (yearBranch) {
    case 'å¯…': case 'åˆ': case 'æˆŒ':
      // å¯…åˆæˆŒå¹´æ”¯åœ¨è¾°ä½èµ·è¿
      startPalaceIndex = 4  // è¾°å®«ç´¢å¼•
      break
    case 'ç”³': case 'å­': case 'è¾°':
      // ç”³å­è¾°å¹´æ”¯åœ¨æˆŒä½èµ·è¿  
      startPalaceIndex = 10 // æˆŒå®«ç´¢å¼•
      break
    case 'å·³': case 'é…‰': case 'ä¸‘':
      // å·³é…‰ä¸‘å¹´æ”¯åœ¨æœªä½èµ·è¿
      startPalaceIndex = 7  // æœªå®«ç´¢å¼•
      break
    case 'äº¥': case 'å¯': case 'æœª':
      // äº¥å¯æœªå¹´æ”¯åœ¨ä¸‘ä½èµ·è¿
      startPalaceIndex = 1  // ä¸‘å®«ç´¢å¼•
      break
    default:
      startPalaceIndex = 0  // é»˜è®¤å­å®«
  }
  
  // è®¡ç®—120å¹´çš„å°é™åˆ†å¸ƒï¼ˆ10ä¸ª12å¹´è½®å›ï¼‰
  for (let age = 1; age <= 120; age++) {
    let palaceIndex: number
    const offset = (age - 1) % 12
    
    if (gender === 'male') {
      // ç”·å‘½ä¸€å¾‹é¡ºè¡Œ
      palaceIndex = (startPalaceIndex + offset) % 12
    } else {
      // å¥³å‘½ä¸€å¾‹é€†è¡Œ
      palaceIndex = (startPalaceIndex - offset + 12) % 12
    }
    
    result[palaceIndex].push(age)
  }
  
  return result
}

/**
 * è®¡ç®—å°é™å²æ•°åˆ†å¸ƒï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
 * Calculate minor period ages distribution based on correct traditional rules
 * @param yearBranch å¹´æ”¯
 * @param gender æ€§åˆ«
 * @param birthDate å‡ºç”Ÿæ—¥æœŸ
 * @returns å„åœ°æ”¯ä½ç½®å¯¹åº”çš„å¹´é¾„æ•°ç»„
 */
export function calculateMinorPeriod(
  yearBranch: string,
  gender: 'male' | 'female', 
  birthDate: Date
): Record<number, number[]> {
  // ä½¿ç”¨æ–°çš„120å¹´è®¡ç®—å‡½æ•°
  return calculate120YearMinorLimits(yearBranch, gender)
}


/**
 * è®¡ç®—æ­£ç¡®çš„è‡ªåŒ–ç³»ç»Ÿ
 * Calculate correct self-transformation system
 * @param palaceStem - æœ¬å®«å¤©å¹²
 * @param starsInPalace - æœ¬å®«æ˜Ÿæ›œåˆ—è¡¨  
 * @param oppositePalaceStem - å¯¹å®«å¤©å¹²
 * @returns æœ¬å®«æ˜Ÿæ›œçš„è‡ªåŒ–æ ‡è®°
 */
export function calculateSelfTransformations(
  palaceStem: string,
  starsInPalace: string[],
  oppositePalaceStem: string
): Array<{
  star: string
  type: 'iA' | 'iB' | 'iC' | 'iD' | 'xA' | 'xB' | 'xC' | 'xD'
  source: 'inward' | 'outward'
}> {
  const transformations: Array<{
    star: string
    type: 'iA' | 'iB' | 'iC' | 'iD' | 'xA' | 'xB' | 'xC' | 'xD'
    source: 'inward' | 'outward'
  }> = []
  
  // è·å–æœ¬å®«å¤©å¹²å››åŒ–å’Œå¯¹å®«å¤©å¹²å››åŒ–
  const palaceSihua = BIRTH_YEAR_SIHUA[palaceStem]
  const oppositeSihua = BIRTH_YEAR_SIHUA[oppositePalaceStem]
  
  starsInPalace.forEach(starName => {
    // 1. ç¦»å¿ƒè‡ªåŒ–ï¼šæœ¬å®«å¤©å¹²å¯¹æœ¬å®«æ˜Ÿæ›œçš„å››åŒ–
    if (palaceSihua) {
      Object.entries(palaceSihua).forEach(([type, sihuaStarName]) => {
        if (sihuaStarName === starName) {
          transformations.push({
            star: starName,
            type: `x${type}` as 'xA' | 'xB' | 'xC' | 'xD',
            source: 'outward'
          })
        }
      })
    }
    
    // 2. å‘å¿ƒè‡ªåŒ–ï¼šå¯¹å®«å¤©å¹²å¯¹æœ¬å®«æ˜Ÿæ›œçš„å››åŒ–
    if (oppositeSihua) {
      Object.entries(oppositeSihua).forEach(([type, sihuaStarName]) => {
        if (sihuaStarName === starName) {
          transformations.push({
            star: starName,
            type: `i${type}` as 'iA' | 'iB' | 'iC' | 'iD',
            source: 'inward'
          })
        }
      })
    }
  })
  
  return transformations
}

/**
 * è®¡ç®—äº”è¡Œå±€è¯¦ç»†ä¿¡æ¯
 * Calculate detailed Five Elements Bureau information
 */
export function calculateFiveElementsBureauDetail(
  yearStem: string,
  yearBranch: string,
  month: number,
  hour: number
): {
  name: string
  å±€æ•°: number
  element: string
  code: string
} {
  // è®¡ç®—å‘½å®«ä½ç½®
  const lifePalaceIndex = calculateLifePalace(month, hour)
  const lifePalaceBranch = BRANCHES[lifePalaceIndex]
  
  // ä½¿ç”¨å¹´å¤©å¹² + å‘½å®«åœ°æ”¯æŸ¥è¡¨
  const ganZhi = yearStem + lifePalaceBranch
  
  if (!FIVE_ELEMENTS_BUREAU[ganZhi]) {
    throw new Error(`Invalid GanZhi combination for Five Elements Bureau: ${ganZhi}`)
  }
  
  const chineseBureau = FIVE_ELEMENTS_BUREAU[ganZhi]
  
  // ä»ä¸­æ–‡äº”è¡Œå±€åç§°è§£æå‡ºè‹±æ–‡ä»£ç  (å¦‚ï¼š"ç«å…­å±€" -> "fire_6")
  const bureauMapping: Record<string, string> = {
    'æ°´äºŒå±€': 'water_2',
    'æœ¨ä¸‰å±€': 'wood_3', 
    'é‡‘å››å±€': 'metal_4',
    'åœŸäº”å±€': 'earth_5',
    'ç«å…­å±€': 'fire_6'
  }
  
  const bureauCode = bureauMapping[chineseBureau] || 'fire_6'
  const [element, numberStr] = bureauCode.split('_')
  const number = parseInt(numberStr) || 6
  
  // è½¬æ¢ä¸ºä¸­æ–‡åç§°
  const elementNames: Record<string, string> = {
    'water': 'æ°´',
    'wood': 'æœ¨', 
    'metal': 'é‡‘',
    'earth': 'åœŸ',
    'fire': 'ç«'
  }
  
  const elementName = elementNames[element] || 'ç«'
  const chineseNumbers = ['', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­']
  const chineseNumber = chineseNumbers[number] || 'å…­'
  
  return {
    name: `${elementName}${chineseNumber}å±€`,
    å±€æ•°: number,
    element: elementName,  // è¿”å›ä¸­æ–‡äº”è¡Œåç§°
    code: bureauCode
  }
}

/**
 * è·å–å®«ä½åç§°
 * Get palace name by index relative to life palace
 */
export function getPalaceName(index: number, lifePalaceIndex: number): string {
  // åäºŒå®«æ˜¯é€†æ—¶é’ˆæ’å¸ƒçš„
  const relativeIndex = (lifePalaceIndex - index + 12) % 12
  return PALACE_NAMES[relativeIndex]
}

/**
 * è·å–æ˜Ÿæ›œåœ¨æŒ‡å®šå®«ä½çš„äº®åº¦æ•°å€¼
 * Get star brightness value at specified palace position
 * @param starName æ˜Ÿæ›œåç§° Star name
 * @param palaceIndex å®«ä½ç´¢å¼• (0-11, å¯¹åº”å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥)
 * @returns äº®åº¦æ•°å€¼ (0-5: é™·å¹³åˆ©å¾—æ—ºåº™)
 */
export function getStarBrightness(starName: string, palaceIndex: number): StarBrightnessValue {
  const brightnessArray = STAR_BRIGHTNESS_TABLE[starName]
  if (!brightnessArray || palaceIndex < 0 || palaceIndex > 11) {
    return STAR_BRIGHTNESS.PING // é»˜è®¤è¿”å›å¹³
  }
  
  const brightnessLevel = brightnessArray[palaceIndex]
  return BRIGHTNESS_LEVEL_MAP[brightnessLevel] || STAR_BRIGHTNESS.PING
}

// å¯¼å…¥å®Œæ•´å‘½ç›˜ç±»å‹å®šä¹‰
import type { 
  ZiWeiCompleteChart, 
  ZiWeiChartInput, 
  BirthInfo, 
  PalaceInfo, 
  StarInfo,
  MajorPeriodInfo
} from './complete-chart-types'

import { 
  getCurrentMajorPeriod as getTimeMajorPeriod,
  calculateAge as getTimeAge
} from './time-calculations'

/**
 * ç”Ÿæˆå®Œæ•´ç´«å¾®æ–—æ•°å‘½ç›˜æ•°æ® - ç»Ÿä¸€å…¥å£å‡½æ•°
 * Generate Complete ZiWei Chart - Unified API Entry Point
 * 
 * è¿™æ˜¯å”¯ä¸€çš„å¯¹å¤–å…¥å£ï¼Œä¸€æ¬¡æ€§ç”Ÿæˆæ‰€æœ‰HOOK APIéœ€è¦çš„æ•°æ®æ ¼å¼
 * This is the single external entry point that generates all data needed for HOOK API
 */
export function generateCompleteZiWeiChart(input: ZiWeiChartInput): ZiWeiCompleteChart {
  try {
    // 1. åˆ›å»ºSolarDayå¯¹è±¡å’ŒBaZiå‚æ•°
    const solarTime = SolarTime.fromYmdHms(input.year, input.month, input.day, input.hour, 0, 0)
    const baziParams = createBaZiParams(solarTime, input.gender === 'male' ? 0 : 1)

    // 2. ç”ŸæˆåŸºç¡€å‡ºç”Ÿä¿¡æ¯  
    const birthInfo: BirthInfo = {
      solar: {
        year: input.year,
        month: input.month,
        day: input.day,
        hour: input.hour,
        gender: input.gender,
        isLunar: input.isLunar || false
      },
      lunar: {
        yearStem: baziParams.yearStem,
        yearBranch: baziParams.yearBranch,
        yearGanzhi: baziParams.yearStem + baziParams.yearBranch,
        monthLunar: baziParams.lunarMonth,
        dayLunar: baziParams.lunarDay,
        hourBranch: baziParams.timeBranch,
        isLunar: input.isLunar,
        isLeapMonth: input.isLeapMonth
      }
    }

    // 3. è®¡ç®—æ ¸å¿ƒå®«ä½ä¿¡æ¯ (ä½¿ç”¨å†œå†æ•°æ®)
    const lifePalaceIndex = calculateLifePalace(baziParams.lunarMonth, baziParams.timeZhiIndex)
    const bodyPalaceIndex = calculateBodyPalace(baziParams.lunarMonth, baziParams.timeZhiIndex)
    
    // 4. è®¡ç®—äº”è¡Œå±€ (ä½¿ç”¨å†œå†æ•°æ®)
    const fiveElementsBureau = calculateFiveElementsBureauDetail(
      baziParams.yearStem,
      baziParams.yearBranch,
      baziParams.lunarMonth,
      baziParams.timeZhiIndex
    )

    // 5. è·å–å‘½ä¸»èº«ä¸» (ä½¿ç”¨å†œå†å¹²æ”¯)
    const lifePalaceBranch = BRANCHES[lifePalaceIndex]
    const masters = calculateMasters(baziParams.yearBranch, lifePalaceBranch)
    const lifeMaster = masters.lifeMaster
    const bodyMaster = masters.bodyMaster

    // 6. è®¡ç®—å„ç±»æ˜Ÿæ›œä½ç½® (ä½¿ç”¨å†œå†æ•°æ®)
    const ziweiPosition = calculateZiweiPosition(fiveElementsBureau.code, baziParams.lunarDay)
    const tianfuPosition = (ziweiPosition + TIANFU_OFFSET_FROM_ZIWEI[ziweiPosition]) % 12
    const mainStarPositions = calculateMainStarPositions(ziweiPosition, tianfuPosition)
    const auxiliaryStarPositions = calculateAuxiliaryStarPositions(
      baziParams.lunarMonth, 
      baziParams.lunarDay, 
      baziParams.timeZhiIndex,
      baziParams.yearStem,
      baziParams.yearBranch,
      lifePalaceIndex
    )
    const maleficStarPositions = calculateMaleficStarPositions(
      baziParams.lunarMonth,
      baziParams.timeZhiIndex,
      baziParams.yearStem,
      baziParams.yearBranch
    )
    const minorStarPositions = calculateMinorStarPositions(
      baziParams.lunarMonth, 
      baziParams.lunarDay, 
      baziParams.timeZhiIndex,
      baziParams.yearStem,
      baziParams.yearBranch,
      lifePalaceIndex, 
      bodyPalaceIndex
    )
    
    // 7. è®¡ç®—å››åŒ–ç³»ç»Ÿ (ç”Ÿå¹´å››åŒ– + é£å®«å››åŒ– + è‡ªåŒ–)
    const birthSihua = calculateBirthYearSihua(baziParams.yearStem)
    // TODO: å®ç°é£å®«å››åŒ–å’Œè‡ªåŒ–ç³»ç»Ÿ
    
    // 8. é¢„å¤„ç†æ‰€æœ‰å®«ä½çš„æ˜Ÿæ›œæ•°æ®
    const allPalacesStarsData = new Map<number, string[]>()
    const allPalacesStemData = new Map<number, string>()
    
    // å…ˆæ”¶é›†æ‰€æœ‰å®«ä½çš„æ˜Ÿæ›œå’Œå¤©å¹²
    for (let i = 0; i < 12; i++) {
      const stem = calculateStemForBranch(i, baziParams.yearStem)
      allPalacesStemData.set(i, stem)
      
      const starsInThisPalace: string[] = []
      
      // æ”¶é›†ä¸»æ˜Ÿ
      mainStarPositions.forEach((positions, starName) => {
        if (positions.includes(i)) {
          starsInThisPalace.push(starName)
        }
      })
      
      // æ”¶é›†è¾…æ˜Ÿ
      auxiliaryStarPositions.forEach((positions, starName) => {
        if (positions.includes(i)) {
          starsInThisPalace.push(starName)
        }
      })
      
      // æ”¶é›†ç…æ˜Ÿ
      maleficStarPositions.forEach((positions, starName) => {
        if (positions.includes(i)) {
          starsInThisPalace.push(starName)
        }
      })
      
      // æ‚è€€ä¸å‚åŠ å››åŒ–ï¼Œä¸éœ€è¦æ”¶é›†åˆ°starsInThisPalace
      
      allPalacesStarsData.set(i, starsInThisPalace)
    }
    
    // 9. é¢„è®¡ç®—120å¹´å°é™åˆ†å¸ƒ
    const minorLimitsDistribution = calculate120YearMinorLimits(baziParams.yearBranch, input.gender, lifePalaceIndex)
    
    // 10. é¢„è®¡ç®—å®Œæ•´å¤§è¿åˆ†å¸ƒ
    const majorPeriodStartAge = calculateMajorPeriodStartAge(fiveElementsBureau.name, baziParams.yearStem, input.gender)
    const isClockwise = (baziParams.yearStem === 'ç”²' || baziParams.yearStem === 'ä¸™' || baziParams.yearStem === 'æˆŠ' || baziParams.yearStem === 'åºš' || baziParams.yearStem === 'å£¬') === (input.gender === 'male')
    const allMajorPeriods = calculateMajorPeriods(majorPeriodStartAge, input.year, lifePalaceIndex, isClockwise)
    
    // æ„å»ºå„å®«ä½çš„å¤§è¿å¹´é¾„åˆ†å¸ƒ
    const majorPeriodsDistribution: Record<number, number[]> = {}
    for (let i = 0; i < 12; i++) {
      majorPeriodsDistribution[i] = []
    }
    
    allMajorPeriods.forEach(period => {
      for (let age = period.startAge; age <= period.endAge; age++) {
        majorPeriodsDistribution[period.palaceIndex].push(age)
      }
    })
    
    // 10. ç”ŸæˆåäºŒå®«å®Œæ•´æ•°æ®
    const palaces: { [branchName: string]: PalaceInfo } = {}
    
    for (let i = 0; i < 12; i++) {
      const branch = BRANCHES[i]
      const stem = calculateStemForBranch(i, baziParams.yearStem)
      const palaceName = getPalaceName(i, lifePalaceIndex)
      
      // æ”¶é›†è¯¥å®«ä½çš„æ‰€æœ‰æ˜Ÿæ›œ
      const mainStars: StarInfo[] = []
      const auxiliaryStars: StarInfo[] = []
      const minorStars: StarInfo[] = []
      
      // æ·»åŠ ä¸»æ˜Ÿ
      mainStarPositions.forEach((positions, starName) => {
        if (positions.includes(i)) {
          const brightness = getStarBrightness(starName, i)
          
          // ç”Ÿå¹´å››åŒ–æ ‡è®°
          let sihuaMark = undefined
          if (birthSihua.A === starName) {
            sihuaMark = 'A'  // ç¦„
          } else if (birthSihua.B === starName) {
            sihuaMark = 'B'  // æƒ
          } else if (birthSihua.C === starName) {
            sihuaMark = 'C'  // ç§‘
          } else if (birthSihua.D === starName) {
            sihuaMark = 'D'  // å¿Œ
          }
          
          mainStars.push({
            name: starName,
            bright: getBrightnessName(brightness),
            sihua: sihuaMark
          })
        }
      })
      
      // æ·»åŠ è¾…æ˜Ÿ
      auxiliaryStarPositions.forEach((positions, starName) => {
        if (positions.includes(i)) {
          const brightness = getStarBrightness(starName, i)
          
          // æ£€æŸ¥è¾…æ˜Ÿçš„ç”Ÿå¹´å››åŒ–
          let sihuaMark = undefined
          if (birthSihua.A === starName) {
            sihuaMark = 'A'
          } else if (birthSihua.B === starName) {
            sihuaMark = 'B'
          } else if (birthSihua.C === starName) {
            sihuaMark = 'C'
          } else if (birthSihua.D === starName) {
            sihuaMark = 'D'
          }
          
          auxiliaryStars.push({
            name: starName,
            bright: getBrightnessName(brightness),
            sihua: sihuaMark
          })
        }
      })
      
      // æ·»åŠ ç…æ˜Ÿ (å½’ç±»åˆ°è¾…æ˜Ÿä¸­)
      maleficStarPositions.forEach((positions, starName) => {
        if (positions.includes(i)) {
          const brightness = getStarBrightness(starName, i)
          
          // æ£€æŸ¥ç…æ˜Ÿçš„ç”Ÿå¹´å››åŒ–
          let sihuaMark = undefined
          if (birthSihua.A === starName) {
            sihuaMark = 'A'
          } else if (birthSihua.B === starName) {
            sihuaMark = 'B'
          } else if (birthSihua.C === starName) {
            sihuaMark = 'C'
          } else if (birthSihua.D === starName) {
            sihuaMark = 'D'
          }
          
          auxiliaryStars.push({
            name: starName,
            bright: getBrightnessName(brightness),
            sihua: sihuaMark
          })
        }
      })
      
      // æ·»åŠ æ‚è€€
      minorStarPositions.forEach((positions, starName) => {
        if (positions.includes(i)) {
          minorStars.push({
            name: starName,
            bright: 'å¹³' // æ‚è€€ä¸€èˆ¬ä¸åˆ†äº®åº¦
          })
        }
      })
      
      // è®¡ç®—å®Œæ•´çš„è‡ªåŒ–ç³»ç»Ÿï¼ˆåŒ…æ‹¬å‘å¿ƒå’Œç¦»å¿ƒï¼‰
      // æ³¨æ„ï¼šæ‚è€€ä¸å‚åŠ å››åŒ–
      const allStarsInPalace = [
        ...mainStars.map(s => s.name),
        ...auxiliaryStars.map(s => s.name)
      ]
      
      // è®¡ç®—å¯¹å®«ç´¢å¼•å’Œå¤©å¹²
      const oppositePalaceIndex = (i + 6) % 12
      const oppositePalaceStem = calculateStemForBranch(oppositePalaceIndex, baziParams.yearStem)
      
      // è®¡ç®—æœ¬å®«æ‰€æœ‰æ˜Ÿæ›œçš„è‡ªåŒ–ï¼ˆå‘å¿ƒ+ç¦»å¿ƒï¼‰
      const allStarsInThisPalace = [...mainStars.map(s => s.name), ...auxiliaryStars.map(s => s.name)]
      const selfTransformations = calculateSelfTransformations(
        stem,
        allStarsInThisPalace,
        oppositePalaceStem
      )
      
      // åº”ç”¨è‡ªåŒ–æ ‡è®°ï¼ˆåªå¯¹ä¸»æ˜Ÿå’Œè¾…æ˜Ÿï¼‰
      const updateStarWithSelfSihua = (stars: StarInfo[]) => {
        stars.forEach(star => {
          const starTransformations = selfTransformations.filter(t => t.star === star.name)
          if (starTransformations.length > 0) {
            star.self_sihua = starTransformations.map(t => t.type).join(',')
          }
        })
      }
      
      // åªæ›´æ–°ä¸»æ˜Ÿå’Œè¾…æ˜Ÿï¼Œæ‚è€€ä¸å‚åŠ å››åŒ–
      updateStarWithSelfSihua(mainStars)
      updateStarWithSelfSihua(auxiliaryStars)
      
      // è®¡ç®—è¯¥å®«ä½çš„å¤§è¿ä¿¡æ¯
      const majorPeriodsInThisPalace = allMajorPeriods.filter(period => period.palaceIndex === i)
      const majorPeriod: MajorPeriodInfo = majorPeriodsInThisPalace.length > 0 ? {
        period: majorPeriodsInThisPalace[0].period,
        startAge: majorPeriodsInThisPalace[0].startAge,
        endAge: majorPeriodsInThisPalace[0].endAge,
        startYear: majorPeriodsInThisPalace[0].startYear,
        endYear: majorPeriodsInThisPalace[0].endYear
      } : {
        period: 0,
        startAge: 0,
        endAge: 0,
        startYear: input.year,
        endYear: input.year
      }
      
      // è®¡ç®—è¯¥å®«ä½çš„æµå¹´å‘¨æœŸ (æŒ‰å¹²æ”¯çºªå¹´æ³•)
      const fleetingYears: number[] = []
      for (let age = 1; age <= 120; age++) {
        // ä»å‡ºç”Ÿå¹´å¹²æ”¯å¼€å§‹ï¼ŒæŒ‰ç”²å­60å¹´å¾ªç¯æ¨ç®—
        const currentYearBranchIndex = (BRANCHES.indexOf(baziParams.yearBranch as any) + age - 1) % 12
        if (currentYearBranchIndex === i) {
          fleetingYears.push(age)
        }
      }
      
      // ä½¿ç”¨ä¼˜åŒ–çš„120å¹´å°é™åˆ†å¸ƒè®¡ç®—
      const minorPeriod = minorLimitsDistribution[i] || []
      
      palaces[branch] = {
        branch,
        branchIndex: i,
        stem,
        palaceName,
        mainStars,
        auxiliaryStars, 
        minorStars,
        fleetingYears,
        majorPeriod,
        minorPeriod,
        palaceStatus: {
          isEmpty: mainStars.length === 0,
          isBorrowingStars: false, // TODO: å®ç°å€Ÿæ˜Ÿé€»è¾‘
          strength: mainStars.length > 0 ? 'normal' : 'weak',
          conflictLevel: 0 // TODO: å®ç°å†²çªè®¡ç®—
        }
      }
    }
    
    // 9. ç»„è£…å®Œæ•´æ•°æ®ç»“æ„
    const completeChart: ZiWeiCompleteChart = {
      birthInfo,
      bazi: baziParams.yearStem + baziParams.yearBranch + baziParams.monthStem + baziParams.monthBranch + baziParams.dayStem + baziParams.dayBranch + baziParams.timeStem + baziParams.timeBranch,
      baziQiyun: `${baziParams.qiyunDetail.years}å¹´${baziParams.qiyunDetail.months}ä¸ªæœˆ`, // å…«å­—èµ·è¿è¯¦ç»†æ—¶é—´
      baziDayun: baziParams.majorPeriods.map(period => 
        `${period.startAge}-${period.endAge}å²: ${period.stem}${period.branch}`
      ).join(', '),
      lifePalace: getPalaceName(lifePalaceIndex, lifePalaceIndex),
      bodyPalace: getPalaceName(bodyPalaceIndex, lifePalaceIndex), 
      laiyinPalace: PALACE_NAMES[(lifePalaceIndex + 6) % 12], // æ¥å› å®«åœ¨è¿ç§»å®«ä½ç½®
      lifeMaster,
      bodyMaster,
      doujun: calculateDouJun(baziParams.lunarMonth, baziParams.timeZhiIndex), // ä½¿ç”¨å†œå†æœˆä»½å’Œæ—¶è¾°ç´¢å¼•
      fiveElementsBureau: {
        name: fiveElementsBureau.name,
        number: fiveElementsBureau.å±€æ•°.toString()
      },
      palaces,
      sihuaAnalysis: {
        birthYearSihua: {
          stem: baziParams.yearStem,
          transformations: {
            lu: birthSihua.A || '',
            quan: birthSihua.B || '',
            ke: birthSihua.C || '',
            ji: birthSihua.D || ''
          }
        }
      },
      generatedAt: new Date().toISOString(),
      version: '1.0.0'
    }
    
    return completeChart
    
  } catch (error) {
    throw new Error(`ZiWei Chart generation failed: ${error instanceof Error ? error.message : 'Unknown error'}`)
  }
}

// è¾…åŠ©å‡½æ•° - è·å–äº®åº¦åç§° (æ ‡å‡†ä¸ƒç­‰çº§åˆ¶)
function getBrightnessName(brightness: StarBrightnessValue): string {
  const names = ['é™·', 'ä¸', 'å¹³', 'åˆ©', 'å¾—', 'æ—º', 'åº™']
  return names[brightness] || 'å¹³'
}


// è¾…åŠ©å‡½æ•° - è®¡ç®—å¹²æ”¯é…å®« 
function calculateStemForBranch(branchIndex: number, yearStem: string): string {
  // ç´«å¾®æ–—æ•°å®«å¹²ç”¨å¹´å¹²èµ·å¯…å®«çš„äº”è™éæ³•
  // äº”è™éè¡¨ï¼šå¹´å¹² -> å¯…å®«èµ·å§‹å¤©å¹²
  const wuHuDunTable: Record<string, string> = {
    'ç”²': 'ä¸™', 'å·±': 'ä¸™',  // ç”²å·±ä¹‹å¹´ä¸™ä½œé¦–
    'ä¹™': 'æˆŠ', 'åºš': 'æˆŠ',  // ä¹™åºšä¹‹å²æˆŠä¸ºå¤´  
    'ä¸™': 'åºš', 'è¾›': 'åºš',  // ä¸™è¾›å¿…å®šä»åºšèµ·
    'ä¸': 'å£¬', 'å£¬': 'å£¬',  // ä¸å£¬å£¬ä½é¡ºæµè¡Œ
    'æˆŠ': 'ç”²', 'ç™¸': 'ç”²'   // æˆŠç™¸ä¹‹å¹´ç”²å¯…å®«
  }
  
  const yinStem = wuHuDunTable[yearStem]
  if (!yinStem) return 'ç”²' // é»˜è®¤å€¼
  
  const yinStemIndex = STEMS.indexOf(yinStem as any)
  
  // è®¡ç®—ä»å¯…å®«(ç´¢å¼•2)åˆ°ç›®æ ‡å®«çš„åç§»é‡
  const offsetFromYin = (branchIndex - 2 + 12) % 12
  
  // åº”ç”¨äº”è™éï¼šä»å¯…å®«å¤©å¹²å¼€å§‹ï¼ŒæŒ‰åå¤©å¹²å¾ªç¯
  const stemIndex = (yinStemIndex + offsetFromYin) % 10
  return STEMS[stemIndex]
}

